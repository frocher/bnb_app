<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">

<dom-module id="bnb-edit-password">
  <style>
    :host {
      @apply(--layout-vertical);
    }
  </style>

  <template>
    <iron-a11y-keys keys="enter" target="[[target]]" on-keys-pressed="submitTapped">
    </iron-a11y-keys>

    <bnb-auth-form id="edit-form" title="Edit your new password">

      <paper-input id="password" label="Password" type="password" value="{{params.password}}" autofocus="true">
      </paper-input>

      <paper-input id="password_confirmation" label="Password confirmation" autocomplete="off" type="password" value="{{params.password_confirmation}}">
      </paper-input>

      <div class="actions">
        <iron-pages id="actionButtons" selected="0">
          <paper-button on-tap="submitTapped">Change</paper-button>
          <paper-button id="goToLoginBtn" on-tap="goLoginTapped">Go to login page</paper-button>
        </iron-pages>
      </div>
    </bnb-auth-form>
  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'bnb-edit-password',

    properties: {
      target: {
        type: Object,
        value: function() {
          return this.$['edit-form'];
        }
      }
    },

    ready: function() {
      this.params = { password: '', password_confirmation: '' };
      this.errors = {};
    },

    submitTapped: function() {
      this.$['password'].invalid = false;
      this.$['password_confirmation'].invalid = false;

      var headers = { 'access-token': this.getQueryVariable('token'), client: this.getQueryVariable('client_id'), uid: this.getQueryVariable('uid') };
      BnbService.updatePassword(this.params, headers, this.handleResponse, this.handleError, this);
    },

    goLoginTapped: function() {
       page('/signin');
    },

    handleResponse: function(response) {
      this.fire('message', {message: response.data.message});
      var buttons = this.$.actionButtons;
      buttons.select('1');
    },

    handleError: function(error) {
      var errors = error.errors;
      if (errors[0] !== undefined) {
        this.fire('message', {message: errors[0]});
      }
      else {
        for (var prop in errors) {
          if (errors.hasOwnProperty(prop)) {
            var objId = '' + prop;
            if (this.$[objId] !== undefined) {
              this.$[objId].invalid = true;
              this.$[objId].errorMessage = errors[prop][0];
            }
          }
        }
      }
    },

    getQueryVariable: function(variable) {
      var hrefPart = window.location.href;
      var query = hrefPart.substring(hrefPart.indexOf('?') + 1);
      var vars = query.split('&');
      for (var i = vars.length - 1;i >= 0 ; i--) {
        var pair = vars[i].split('=');
        if(pair[0] === variable) {
          return decodeURIComponent(pair[1]);
        }
      }
      return undefined;
    }

  });

})();

</script>
