<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="bnb-period-dropdown.html">
<link rel="import" href="bnb-chart-card.html">

<dom-module id="bnb-page">
  <style>
    :host {
      @apply(--layout-vertical);
    }

    #content {
    }

    #charts {
      @apply(--layout-vertical);
      @apply(--layout-wrap);
      @apply(--layout-center-justified);
    }

    paper-toolbar ::content > #middleBar {
      z-index: 9999;
    }

  </style>
  <template>
    <iron-media-query query="(min-width: 600px)" query-matches="{{wide}}"></iron-media-query>

    <paper-header-panel id="panel" class="flex">
      <paper-toolbar class$="{{computeToolbarClass(wide)}}">
        <paper-icon-button icon="arrow-back" on-tap="backTapped"></paper-icon-button>
        <template is="dom-if" if="{{!wide}}">
          <span>[[page.name]]</span>
          <div class="flex middle"></div>
          <bnb-period-dropdown class="middle" period="{{period}}"></bnb-period-dropdown>
        </template>
        <template is="dom-if" if="{{wide}}">
          <span>
            <span>[[page.name]]</span>
            <span> stats for&nbsp;</span>
            <bnb-period-dropdown period="{{period}}"></bnb-period-dropdown>
          </span>
        </template>
        <div class="flex"></div>
        <paper-menu-button horizontal-align="right">
          <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
          <paper-menu class="dropdown-content" style="z-index:9999">
            <paper-item on-tap="editTapped" hidden$="{{!page.can_edit}}">Settings</paper-item>
            <paper-item on-tap="membersTapped">Members</paper-item>
            <paper-divider hidden$="{{!page.can_delete}}"></paper-divider>
            <paper-item on-tap="deleteTapped" hidden$="{{!page.can_delete}}">Delete</paper-item>
          </paper-menu>
        </paper-menu-button>
      </paper-toolbar>

      <div id="content" class="fit">

        <div id="charts">
          <bnb-chart-card id="performanceChart" name="Load times" data="[[page.stats.performance]]" model="[[performanceModel]]"></bnb-chart-card>
          <bnb-chart-card id="uptimeChart" name="Uptime" data="[[page.stats.uptime]]" model="[[uptimeModel]]"></bnb-chart-card>
          <bnb-chart-card id="requestsChart" name="Assets count" stacked="true" data="[[page.stats.requests]]" model="[[requestsModel]]"></bnb-chart-card>
          <bnb-chart-card id="bytesChart" name="Assets size" stacked="true" data="[[page.stats.bytes]]" model="[[bytesModel]]"></bnb-chart-card>
        </div>

        <paper-dialog id="deleteDlg" modal>
          <p>Delete page ?</p>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm autofocus on-tap="deletePage">Delete</paper-button>
          </div>
        </paper-dialog>
      </div>
    </paper-header-panel>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'bnb-page',

    properties: {
      page: {
        type: Object,
        value: null
      },
      period: {
        type: Object
      },
      performanceModel: {
        type: Object
      }
    },

    behaviors: [
      Polymer.NeonAnimatableBehavior,
      Polymer.IronResizableBehavior
    ],

    ready: function() {
      this.performanceModel = [
        {name: 'response_start', color: '#E65100', label: 'response time', suffix: 'ms'},
        {name: 'first_paint', color: '#F57C00', label: 'first paint', suffix: 'ms'},
        {name: 'speed_index', color: '#FF9800', label: 'speed index'},
        {name: 'dom_ready', color: '#FFB74D', label: 'dom ready', suffix: 'ms'},
        {name: 'page_load', color: '#FFE0B2', label: 'fully loaded', suffix: 'ms'}
      ];

      this.uptimeModel = [
        {name: 'uptime', color: '#00C853', label: 'uptime', suffix: '%'}
      ];

      this.requestsModel = [
        {name: 'html', color: '#01579B', label: 'html'},
        {name: 'css', color: '#0288D1', label: 'css'},
        {name: 'js', color: '#03A9F4', label: 'javascript'},
        {name: 'image', color: '#4FC3F7', label: 'image'},
        {name: 'font', color: '#81D4FA', label: 'font'},
        {name: 'other', color: '#B3E5FC', label: 'other'}
      ];

      this.bytesModel = [
        {name: 'html', color: '#880E4F', label: 'html', suffix: 'kb'},
        {name: 'css', color: '#C2185B', label: 'css', suffix: 'kb'},
        {name: 'js', color: '#D81B60', label: 'javascript', suffix: 'kb'},
        {name: 'image', color: '#EC407A', label: 'image', suffix: 'kb'},
        {name: 'font', color: '#F48FB1', label: 'font', suffix: 'kb'},
        {name: 'other', color: '#F8BBD0', label: 'other', suffix: 'kb'}
      ];
    },

    computeToolbarClass: function(param) {
      return this.wide ? "" : "medium-tall";
    },

    backTapped: function(e) {
      this.fire('show-pages');
    },

    editTapped: function(e) {
      this.fire('edit-page', {page: this.page});
    },

    membersTapped: function(e) {
      this.fire('edit-members', {page: this.page});
    },

    deleteTapped: function(e) {
      this.$.deleteDlg.open();
    },

    deletePage: function(e) {
      BnbService.deletePage(this.page.id, this.handleResponse, this.handleError, this);
    },

    handleResponse: function(data) {
      this.fire('page-deleted', {page: page});
      this.fire('message', {message: "Page has been deleted"});
    },

    handleError: function(error) {
      this.fire('message', {message: "Error : can't delete page"});
    }
  });

})();
</script>
