<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">

<dom-module id="bnb-members-page">
  <style>
    h3 {
      color: var(--secondary-text-color);
    }

    #content {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }

    #container {
      width: 100%;
      max-width: 1000px;
      padding: 10px 22px 10px 22px;
    }

    #email {
      min-width: 200px;
      margin-right: 16px;
    }

    #members {
      max-height: 400px;
    }
  </style>
  <template>
    <paper-header-panel class="flex center">
      <paper-toolbar>
        <paper-icon-button icon="arrow-back" on-tap="closeTapped"></paper-icon-button>
        <span class="title">Members</span>
      </paper-toolbar>
      <div id="content">
        <div id="container">
          <div class="layout horizontal wrap end">
            <paper-input id="email" class="flex" label="E-mail" on-input="emailChanged" required="true" error-message="You should enter a valid email address"></paper-input>
            <paper-dropdown-menu id="roleMenu" label="Role" required="true" error-message="You should select a role">
              <paper-menu id="role" class="dropdown-content" attr-for-selected="role">
                <paper-item role="admin">Administrator</paper-item>
                <paper-item role="master">Master</paper-item>
                <paper-item role="editor">Editor</paper-item>
                <paper-item role="guest">Guest</paper-item>
              </paper-menu>
            </paper-dropdown-menu>

            <iron-pages id="buttons" selected="0">
              <section>
                <paper-button id="addBtn" hidden$="[[!page.can_add_member]]" on-tap="addTapped">Add</paper-button>
              </section>
              <section>
                <paper-button id="updateBtn" hidden$="[[!page.can_update_member]]" on-tap="updateTapped">Update</paper-button>
                <paper-button id="removeBtn" hidden$="[[!page.can_remove_member]]" on-tap="removeTapped">Remove</paper-button>
              </section>
            </iron-pages>
          </div>

          <h3>Members</h3>
          <vaadin-grid id="members" items="[[_computeMembers(page.members)]]" selection-mode="single" on-selected-items-changed="memberChanged">
            <table>
              <colgroup>
                <col name="username">
                <col name="email">
                <col name="role">
              </colgroup>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </vaadin-grid>
        </div>
      </div>
    </paper-header-panel>


  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'bnb-members-page',

    properties: {
      page: {
        type: Object,
        value: null
      },
      target: {
        type: Object,
        value: function() {
          return this.$.content;
        }
      }
    },

    behaviors: [
      Polymer.NeonAnimatableBehavior,
      Polymer.IronResizableBehavior
    ],

    closeTapped: function() {
      this.closePage();
    },

    closePage: function() {
      this.$.email.invalid = false;
      this.fire('show-page', {page: this.page});
    },

    emailChanged: function() {
      var value = this.$.email.value;
      var member = _.find(this.page.members, function(o) { return o.email === value; });
      if (member == undefined) {
        this.$.buttons.selected = 0;
      }
      else {
        this.$.buttons.selected = 1;
      }
    },

    addTapped: function() {
      if (this.validateInputs()) {
        var email = this.$.email.value;
        var role = this.$.role.selected;
        this.fire('add-member', {email: email, role:role});
      }
    },

    updateTapped: function() {
      if (this.validateInputs()) {
        var email = this.$.email.value;
        var role = this.$.role.selected;
        var member = _.find(this.page.members, function(o) { return o.email === email; });
        this.fire('update-member', {id: member.id, email: email, role:role});
      }
    },

    removeTapped: function() {
      if (this.validateInputs()) {
        var email = this.$.email.value;
        var member = _.find(this.page.members, function(o) { return o.email === email; });
        this.fire('remove-member', {id: member.id});
      }
    },

    validateInputs: function() {
      var emailOK = this.$.email.validate();
      var roleOK = this.$.roleMenu.validate();
      return emailOK && roleOK;
    },

    memberChanged: function() {
      var selected = this.$.members.selection.selected();
      if (selected.length > 0) {
        var member = this.page.members[selected[0]];
        this.$.email.value = member.email;
        this.$.role.selected = member.role;
        this.emailChanged();
      }
    },

    _computeMembers: function(members) {
      if (members === undefined) {
        return [];
      }
      return members;
    }
  });

})();
</script>
