<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="bnb-signin.html">
<link rel="import" href="bnb-signup.html">
<link rel="import" href="bnb-forgot-password.html">
<link rel="import" href="bnb-edit-password.html">
<link rel="import" href="bnb-pages.html">
<link rel="import" href="bnb-page.html">
<link rel="import" href="bnb-add-page.html">
<link rel="import" href="bnb-edit-page.html">
<link rel="import" href="bnb-members-page.html">

<dom-module id="bnb-app">
  <style>
    :host {
      @apply(--layout-vertical);
      background-color: var(--primary-background-color);
    }

    .page {
      @apply(--layout-fit);
    }

    #version {
      display: flex;
      height:100%;
      justify-content: flex-end;
      align-items: flex-end;
      font-size: 12px;
      color: var(--disabled-text-color);
      opacity: 0.5;
    }
  </style>

  <template>
    <span id="version">v0.1</span>

    <neon-animated-pages id="animated" class="page" attr-for-selected="data-route" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
      <neon-animatable     id="splash"       class="page" data-route="splash">Splash !!!</neon-animatable>
      <bnb-signin          id="signin"       class="page" data-route="signin"></bnb-signin>
      <bnb-signup          id="signup"       class="page" data-route="signup"></bnb-signup>
      <bnb-forgot-password id="forgot"       class="page" data-route="forgot"></bnb-forgot-password>
      <bnb-edit-password   id="editPassword" class="page" data-route="edit-password"></bnb-edit-password>
      <bnb-pages           id="pages"        class="page" data-route="home" period="{{period}}" pages="{{pages}}"></bnb-pages>
      <bnb-add-page        id="addPage"      class="page" data-route="add-page" pages="{{pages}}"></bnb-add-page>
      <bnb-page            id="page"         class="page" data-route="page" period="{{period}}" page="{{page}}"></bnb-page>
      <bnb-edit-page       id="editPage"     class="page" data-route="edit-page" page="{{page}}"></bnb-edit-page>
      <bnb-members-page    id="editMembers"  class="page" data-route="edit-members" page="{{page}}"></bnb-members-page>
    </neon-animated-pages>

    <paper-toast id="message-toast"></paper-toast>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'bnb-app',

    listeners: {
      'message'        : 'handleMessage',
      'signedin'       : 'handleSignedIn',
      'signedout'      : 'handleSignedOut',
      'show-pages'     : 'handleShowPages',
      'show-page'      : 'handleShowPage',
      'edit-page'      : 'handleEditPage',
      'edit-members'   : 'handleEditMembers',
      'page-created'   : 'handlePageCreated',
      'page-deleted'   : 'handlePageDeleted',
      'period-changed' : 'handlePeriodChanged',
      'add-member'     : 'handleAddMember',
      'update-member'  : 'handleUpdateMember',
      'remove-member'  : 'handleRemoveMember'
    },

    properties: {
      pages: {
        type: Array,
        value: function() {
          return [];
        }
      },

      user: {
        type: Object,
        value: null
      },

      page: {
        type: Object,
        value: null
      },

      period: {
        type: Object,
        value: {start: moment().subtract(30, 'days').toDate(), end: moment().toDate()}
      },

      route: {
        type: String,
        observer: 'handleRouteChanged'
      }
    },

    loadPages: function() {
      BnbService.loadPages({}, this.handleLoadPagesResponse, this.handleGenericError, this);
    },

    loadPage: function(id) {
      BnbService.loadPage(id, {}, this.handleLoadPageResponse, this.handleGenericError, this);
    },

    loadMembers: function(id) {
      var _this = this;
      BnbService.loadPage(id, {},
        function(data) {
          _this.page = data;
          BnbService.loadMembers(id, _this.handleLoadMembersResponse, _this.handleGenericError, _this);
        },
        this.handleGenericError, this);
    },

    loadPageMeasures: function() {
      var start = this.period.start;
      var end   = this.period.end;

      BnbService.loadStats(this.page.id, start, end, this.handleLoadStatsResponse, this.handleGenericError, this);
      BnbService.loadUptimes(this.page.id, 'point', start, end, this.handleLoadUptimeResponse, this.handleGenericError, this);
      BnbService.loadChecks(this.page.id, 'point', 'desktop', start, end, this.handleLoadCheckResponse, this.handleGenericError, this);
      BnbService.loadUptimes(this.page.id, 'points', start, end, this.handleLoadUptimesResponse, this.handleGenericError, this);
      BnbService.loadChecks(this.page.id, 'points', 'desktop', start, end, this.handleLoadChecksResponse, this.handleGenericError, this);
    },

    handleRouteChanged: function(newValue, oldValue) {
      if (newValue === 'add-page' || newValue === 'edit-page' || newValue === 'edit-members') {
        this.entryAnimation = 'slide-from-bottom-animation';
        this.exitAnimation = 'slide-up-animation';
      }
      else if (oldValue === 'add-page' || oldValue === 'edit-page' || oldValue === 'edit-members') {
        this.entryAnimation = 'slide-from-top-animation';
        this.exitAnimation = 'slide-down-animation';
      }
      else {
        this.entryAnimation = 'fade-in-animation';
        this.exitAnimation = 'fade-out-animation';
      }
      this.$.animated.select(newValue);
    },

    handleLoadPagesResponse: function(data) {
      this.pages = data;
    },

    handleLoadPageResponse: function(data) {
      this.page = data;
      this.loadPageMeasures();
    },

    handleLoadStatsResponse: function(data) {
      this.page.stats = data;
      this.notifyPath('page.stats', this.page.stats);
    },

    handleLoadUptimeResponse: function(data) {
      if (data.length > 0) {
        this.page.uptime = Math.round(data[0].value * 10000) / 100;
      }
      else {
        this.page.uptime = 0;
      }
      this.notifyPath('page.uptime', this.page.uptime);
    },

    handleLoadUptimesResponse: function(data) {
      this.page.uptimes = data;
      this.notifyPath('page.uptimes', this.page.uptimes);
    },

    handleLoadCheckResponse: function(data) {
      if (data.length > 0) {
        this.page.domReady = Math.round(data[0].dom_ready);
        this.page.firstPaint = Math.round(data[0].first_paint);
        this.page.pageLoad = Math.round(data[0].page_load);
        this.page.responseStart = Math.round(data[0].response_start);
        this.page.speedIndex = Math.round(data[0].speed_index);
      }
      else {
        this.page.domReady = 0;
        this.page.firstPaint = 0;
        this.page.pageLoad = 0;
        this.page.responseStart = 0;
        this.page.speedIndex = 0;
      }

      this.notifyPath('page.domReady', this.page.domReady);
      this.notifyPath('page.firstPaint', this.page.firstPaint);
      this.notifyPath('page.pageLoad', this.page.pageLoad);
      this.notifyPath('page.responseStart', this.page.responseStart);
      this.notifyPath('page.speedIndex', this.page.speedIndex);
    },

    handleLoadChecksResponse: function(data) {
      this.page.domReadies     = [];
      this.page.firstPaints    = [];
      this.page.pageLoads      = [];
      this.page.responseStarts = [];
      this.page.speedIndexes   = [];
      var arrayLength = data.length;
      for (var i = 0; i < arrayLength; i++) {
        this.page.domReadies.push({time: data[i].time, value:Math.round(data[i].dom_ready)});
        this.page.firstPaints.push({time: data[i].time, value:Math.round(data[i].first_paint)});
        this.page.pageLoads.push({time: data[i].time, value:Math.round(data[i].page_load)});
        this.page.responseStarts.push({time: data[i].time, value:Math.round(data[i].response_start)});
        this.page.speedIndexes.push({time: data[i].time, value:Math.round(data[i].speed_index)});
      }

      this.notifyPath('page.domReadies', this.page.domReadies);
      this.notifyPath('page.firstPaints', this.page.firstPaints);
      this.notifyPath('page.pageLoads', this.page.pageLoads);
      this.notifyPath('page.responseStarts', this.page.responseStarts);
      this.notifyPath('page.speedIndexes', this.page.speedIndexes);
    },

    handleLoadMembersResponse: function(data) {
      this.page.members = data;
      this.notifyPath('page.members', this.page.members);
    },

    handleAddMember: function(data) {
      BnbService.addMember(this.page.id, data.detail, this.handleAddMemberResponse, this.handleGenericError, this);
    },

    handleAddMemberResponse: function(data) {
      this.loadMembers(this.page.id);
    },

    handleUpdateMember: function(data) {
      var params = {email: data.detail.email, role: data.detail.role };
      BnbService.updateMember(this.page.id, data.detail.id, params, this.handleUpdateMemberResponse, this.handleGenericError, this);
    },

    handleUpdateMemberResponse: function(data) {
      this.loadMembers(this.page.id);
    },

    handleRemoveMember: function(data) {
      BnbService.removeMember(this.page.id, data.detail.id, this.handleRemoveMemberResponse, this.handleGenericError, this);
    },

    handleRemoveMemberResponse: function(data) {
      this.loadMembers(this.page.id);
    },

    handleGenericError: function(error) {
      if (error.errors) {
        this.fire('message', {message: error.errors[0]});
      }
      else if (error.message) {
        this.fire('message', {message: error.message});
      }
      else {
        this.fire('message', {message: 'Sorry, an error as occured'});
      }
    },

    handleMessage: function(e) {
      this.showToast(e.detail.message);
    },

    handlePeriodChanged: function(e) {
      if (this.route === 'page') {
        this.loadPageMeasures();
      }
    },

    handleShowPages: function(e) {
      page('/');
    },

    handleShowPage: function(e) {
      var path = '/page/' + e.detail.page.id;
      page(path);
    },

    handleEditPage: function(e) {
      var path = '/edit-page/' + e.detail.page.id;
      page(path);
    },

    handleEditMembers: function(e) {
      var path = '/edit-members/' + e.detail.page.id;
      page(path);
    },

    handlePageCreated: function(e) {
      this.loadPages();
      page('/');
    },

    handlePageDeleted: function(e) {
      this.loadPages();
      page('/');
    },

    handleSignedIn: function(e) {
      this.user = e.detail.user;
      page('/');
    },

    handleSignedOut: function(e) {
      BnbService.signout();
      page('/signin');
    },

    showToast: function(message) {
      var toast = this.$['message-toast'];
      toast.text = message;
      toast.show();
    },
 });

})();
</script>
