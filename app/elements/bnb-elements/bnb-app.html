<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">
<link rel="import" href="../../bower_components/platinum-sw/platinum-sw-cache.html">
<link rel="import" href="../../bower_components/platinum-sw/platinum-sw-register.html">
<link rel="import" href="bnb-signin.html">
<link rel="import" href="bnb-signup.html">
<link rel="import" href="bnb-forgot-password.html">
<link rel="import" href="bnb-edit-password.html">
<link rel="import" href="bnb-pages.html">
<link rel="import" href="bnb-page.html">
<link rel="import" href="bnb-add-page.html">
<link rel="import" href="bnb-edit-page.html">
<link rel="import" href="bnb-members-page.html">
<link rel="import" href="bnb-user-preferences.html">

<dom-module id="bnb-app">
  <style>
    :host {
      @apply(--layout-vertical);
      background-color: var(--primary-background-color);
    }

    .page {
      @apply(--layout-fit);
    }

    #version {
      display: flex;
      height:100%;
      justify-content: flex-end;
      align-items: flex-end;
      font-size: 12px;
      color: var(--disabled-text-color);
      opacity: 0.5;
    }
  </style>

  <template>
    <span id="version">v0.1</span>

    <neon-animated-pages id="animated" class="page" attr-for-selected="data-route" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
      <neon-animatable      id="splash"          class="page" data-route="splash">Splash !!!</neon-animatable>
      <bnb-signin           id="signin"          class="page" data-route="signin"></bnb-signin>
      <bnb-signup           id="signup"          class="page" data-route="signup"></bnb-signup>
      <bnb-forgot-password  id="forgot"          class="page" data-route="forgot"></bnb-forgot-password>
      <bnb-edit-password    id="editPassword"    class="page" data-route="edit-password"></bnb-edit-password>
      <bnb-pages            id="pages"           class="page" data-route="home" period="{{period}}" pages="{{pages}}"></bnb-pages>
      <bnb-add-page         id="addPage"         class="page" data-route="add-page" pages="{{pages}}"></bnb-add-page>
      <bnb-page             id="page"            class="page" data-route="page" period="{{period}}" page="{{page}}"></bnb-page>
      <bnb-edit-page        id="editPage"        class="page" data-route="edit-page" page="{{page}}"></bnb-edit-page>
      <bnb-members-page     id="editMembers"     class="page" data-route="edit-members" page="{{page}}"></bnb-members-page>
      <bnb-user-preferences id="userPreferences" class="page" data-route="preferences" user="{{user}}"></bnb-user-preferences>
    </neon-animated-pages>

    <paper-toast id="message-toast"></paper-toast>

    <paper-toast id="caching-complete"
                 duration="6000"
                 text="Caching complete! This app will work offline.">
    </paper-toast>
    <platinum-sw-register auto-register
                          clients-claim
                          skip-waiting
                          base-uri="bower_components/platinum-sw/bootstrap"
                          on-service-worker-installed="displayInstalledToast">
      <platinum-sw-cache default-cache-strategy="fastest"
                         cache-config-file="cache-config.json">
      </platinum-sw-cache>
    </platinum-sw-register>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'bnb-app',

    listeners: {
      'message'          : 'handleMessage',
      'signedin'         : 'handleSignedIn',
      'signedout'        : 'handleSignedOut',
      'show-pages'       : 'handleShowPages',
      'show-page'        : 'handleShowPage',
      'edit-page'        : 'handleEditPage',
      'edit-preferences' : 'handleEditPreferences',
      'edit-members'     : 'handleEditMembers',
      'page-created'     : 'handlePageCreated',
      'page-deleted'     : 'handlePageDeleted',
      'period-changed'   : 'handlePeriodChanged',
      'add-member'       : 'handleAddMember',
      'update-member'    : 'handleUpdateMember',
      'remove-member'    : 'handleRemoveMember'
    },

    properties: {
      pages: {
        type: Array,
        value: function() {
          return [];
        }
      },

      user: {
        type: Object,
        value: null
      },

      page: {
        type: Object,
        value: null
      },

      period: {
        type: Object,
        value: {start: moment().subtract(30, 'days').toDate(), end: moment().toDate()}
      },

      route: {
        type: String,
        observer: 'handleRouteChanged'
      }
    },

    displayInstalledToast: function() {
      // Check to make sure caching is actually enabledâ€”it won't be in the dev environment.
      if (!Polymer.dom(document).querySelector('platinum-sw-cache').disabled) {
        Polymer.dom(document).querySelector('#caching-complete').show();
      }
    },

    loadPages: function() {
      BnbService.loadPages({}, this.handleLoadPagesResponse, this.handleGenericError, this);
    },

    loadPage: function(id) {
      BnbService.loadPage(id, {}, this.handleLoadPageResponse, this.handleGenericError, this);
    },

    loadUser: function() {
      BnbService.loadUser(-1, {}, this.handleLoadUserResponse, this.handleGenericError, this);
    },

    loadMembers: function(id) {
      var _this = this;
      BnbService.loadPage(id, {},
        function(data) {
          _this.page = data;
          BnbService.loadMembers(id, _this.handleLoadMembersResponse, _this.handleGenericError, _this);
        },
        this.handleGenericError, this);
    },

    loadPageMeasures: function() {
      var start = this.period.start;
      var end   = this.period.end;
      BnbService.loadStats(this.page.id, start, end, this.handleLoadStatsResponse, this.handleGenericError, this);
    },

    handleRouteChanged: function(newValue, oldValue) {
      if (newValue === 'add-page' || newValue === 'edit-page' || newValue === 'edit-members') {
        this.entryAnimation = 'slide-from-bottom-animation';
        this.exitAnimation = 'slide-up-animation';
      }
      else if (oldValue === 'add-page' || oldValue === 'edit-page' || oldValue === 'edit-members') {
        this.entryAnimation = 'slide-from-top-animation';
        this.exitAnimation = 'slide-down-animation';
      }
      else {
        this.entryAnimation = 'fade-in-animation';
        this.exitAnimation = 'fade-out-animation';
      }
      this.$.animated.select(newValue);
    },

    handleLoadPagesResponse: function(data) {
      this.pages = data;
    },

    handleLoadPageResponse: function(data) {
      this.page = data;
      this.loadPageMeasures();
    },

    handleLoadUserResponse: function(data) {
      this.user = data;
    },

    handleLoadStatsResponse: function(data) {
      this.updateUptime(data.uptime[0]);
      this.updateCount(data.performance.desktop);
      this.updateCount(data.performance.mobile);
      this.updateBytes(data.bytes.desktop);
      this.updateBytes(data.bytes.mobile);
      this.updateCount(data.requests.desktop);
      this.updateCount(data.requests.mobile);

      this.page.stats = data;
      this.notifyPath('page.stats', this.page.stats);
    },

    updateUptime: function(data) {
      data.summary = Math.round(data.summary * 10000) / 100;
      for (var i = 0; i < data.values.length; i++) {
        data.values[i].value = Math.round(data.values[i].value * 10000) / 100;
      }
    },

    updateCount: function(data) {
      for (var iSeries = 0; iSeries < data.length; iSeries++) {
        var serie = data[iSeries];
        serie.summary = Math.round(serie.summary);
        for (var iValue = 0; iValue < serie.values.length; iValue++) {
          serie.values[iValue].value = Math.round(serie.values[iValue].value);
        }
      }
    },

    updateBytes: function(data) {
      for (var iSeries = 0; iSeries < data.length; iSeries++) {
        var serie = data[iSeries];
        serie.summary = Math.round(serie.summary*10/1024)/10;
        for (var iValue = 0; iValue < serie.values.length; iValue++) {
          serie.values[iValue].value = Math.round(serie.values[iValue].value*10/1024)/10;
        }
      }
    },

    handleLoadMembersResponse: function(data) {
      this.page.members = data;
      this.notifyPath('page.members', this.page.members);
    },

    handleAddMember: function(data) {
      BnbService.addMember(this.page.id, data.detail, this.handleAddMemberResponse, this.handleGenericError, this);
    },

    handleAddMemberResponse: function(data) {
      this.loadMembers(this.page.id);
    },

    handleUpdateMember: function(data) {
      var params = {email: data.detail.email, role: data.detail.role };
      BnbService.updateMember(this.page.id, data.detail.id, params, this.handleUpdateMemberResponse, this.handleGenericError, this);
    },

    handleUpdateMemberResponse: function(data) {
      this.loadMembers(this.page.id);
    },

    handleRemoveMember: function(data) {
      BnbService.removeMember(this.page.id, data.detail.id, this.handleRemoveMemberResponse, this.handleGenericError, this);
    },

    handleRemoveMemberResponse: function(data) {
      this.loadMembers(this.page.id);
    },

    handleGenericError: function(error) {
      if (error.errors) {
        this.fire('message', {message: error.errors[0]});
      }
      else if (error.message) {
        this.fire('message', {message: error.message});
      }
      else {
        this.fire('message', {message: 'Sorry, an error as occured'});
      }
    },

    handleMessage: function(e) {
      this.showToast(e.detail.message);
    },

    handlePeriodChanged: function(e) {
      if (this.route === 'page') {
        this.loadPageMeasures();
      }
    },

    handleShowPages: function(e) {
      page('/');
    },

    handleShowPage: function(e) {
      var path = '/page/' + e.detail.page.id;
      page(path);
    },

    handleEditPage: function(e) {
      var path = '/edit-page/' + e.detail.page.id;
      page(path);
    },

    handleEditPreferences: function(e) {
      page('/preferences');
    },

    handleEditMembers: function(e) {
      var path = '/edit-members/' + e.detail.page.id;
      page(path);
    },

    handlePageCreated: function(e) {
      this.loadPages();
      page('/');
    },

    handlePageDeleted: function(e) {
      this.loadPages();
      page('/');
    },

    handleSignedIn: function(e) {
      this.user = e.detail.user.data;
      page('/');
    },

    handleSignedOut: function(e) {
      BnbService.signout();
      page('/signin');
    },

    showToast: function(message) {
      var toast = this.$['message-toast'];
      toast.text = message;
      toast.show();
    },
 });

})();
</script>
