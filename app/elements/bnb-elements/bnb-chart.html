<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<script src="../../bower_components/d3/d3.min.js"></script>
<script src="../../bower_components/nvd3/build/nv.d3.min.js"></script>

<dom-module id="bnb-chart">
  <template>

    <style>
      :host {
        display: inline-block;
      }

      iron-pages {
        width: 100%;
        height: 100%;
      }

      #canvas {
        position:relative;

        width: 100%;
        height: 100%;
      }

      #loading {
        display: flex;

        width: 100%;
        height: 100%;

        color: #999;

        font-size: 24px;

        align-items: center;
        justify-content: center;
      }

      #canvas > svg {
        width: 100% !important;
      }

      #noData {
        display: flex;

        width: 100%;
        height: 100%;

        color: #999;

        font-size: 36px;

        align-items: center;
        justify-content: center;
      }
      #noData span {
        margin-top: -50px;
      }

      /* nvd3 version 1.8.4 (https://github.com/novus/nvd3) 2016-07-03 */
      .nvd3 .nv-axis {
          pointer-events:none;
          opacity: 1;
      }

      .nvd3 .nv-axis path {
          fill: none;
          stroke: #000;
          stroke-opacity: .75;
          shape-rendering: crispEdges;
      }

      .nvd3 .nv-axis path.domain {
          stroke-opacity: .75;
      }

      .nvd3 .nv-axis.nv-x path.domain {
          stroke-opacity: 0;
      }

      .nvd3 .nv-axis line {
          fill: none;
          stroke: #e5e5e5;
          shape-rendering: crispEdges;
      }

      .nvd3 .nv-axis .zero line,
          /*this selector may not be necessary*/ .nvd3 .nv-axis line.zero {
          stroke-opacity: .75;
      }

      .nvd3 .nv-axis .nv-axisMaxMin text {
          font-weight: bold;
      }

      .nvd3 .x  .nv-axis .nv-axisMaxMin text,
      .nvd3 .x2 .nv-axis .nv-axisMaxMin text,
      .nvd3 .x3 .nv-axis .nv-axisMaxMin text {
          text-anchor: middle
      }

      .nvd3 .nv-axis.nv-disabled {
          opacity: 0;
      }

      .nvd3 .nv-bars rect {
          fill-opacity: .75;

          transition: fill-opacity 250ms linear;
          -moz-transition: fill-opacity 250ms linear;
          -webkit-transition: fill-opacity 250ms linear;
      }


      .nv-force-node {
        stroke: #fff;
        stroke-width: 1.5px;
      }
      .nv-force-link {
        stroke: #999;
        stroke-opacity: .6;
      }
      .nv-force-node text {
        stroke-width: 0px
      }

      .nvd3 .nv-legend .nv-disabled rect {
          /*fill-opacity: 0;*/
      }

      .nvd3 .nv-check-box .nv-box {
          fill-opacity:0;
          stroke-width:2;
      }

      .nvd3 .nv-check-box .nv-check {
          fill-opacity:0;
          stroke-width:4;
      }

      .nvd3 .nv-series.nv-disabled .nv-check-box .nv-check {
          fill-opacity:0;
          stroke-opacity:0;
      }

      .nvd3 .nv-controlsWrap .nv-legend .nv-check-box .nv-check {
          opacity: 0;
      }

      .nvd3 .nv-groups path.nv-line {
          fill: none;
      }

      .nvd3 .nv-groups path.nv-area {
          stroke: none;
      }

      .nvd3.nv-line .nvd3.nv-scatter .nv-groups .nv-point {
          fill-opacity: 0;
          stroke-opacity: 0;
      }

      .nvd3.nv-scatter.nv-single-point .nv-groups .nv-point {
          fill-opacity: .5 !important;
          stroke-opacity: .5 !important;
      }


      .with-transitions .nvd3 .nv-groups .nv-point {
          transition: stroke-width 250ms linear, stroke-opacity 250ms linear;
          -moz-transition: stroke-width 250ms linear, stroke-opacity 250ms linear;
          -webkit-transition: stroke-width 250ms linear, stroke-opacity 250ms linear;

      }

      .nvd3.nv-scatter .nv-groups .nv-point.hover,
      .nvd3 .nv-groups .nv-point.hover {
          stroke-width: 7px;
          fill-opacity: .95 !important;
          stroke-opacity: .95 !important;
      }


      .nvd3 .nv-point-paths path {
          stroke: #aaa;
          stroke-opacity: 0;
          fill: #eee;
          fill-opacity: 0;
      }

      .nvd3 .nv-indexLine {
          cursor: ew-resize;
      }

      /********************
        Default CSS for an svg element nvd3 used
      */
      svg.nvd3-svg {
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -ms-user-select: none;
          -moz-user-select: none;
          user-select: none;
          display: block;
          width:100%;
          height:100%;
      }

      .nvd3 text {
          font: normal 12px Arial;
      }

      .nvd3 .title {
          font: bold 14px Arial;
      }

      .nvd3 .nv-background {
          fill: white;
          fill-opacity: 0;
      }

      .nvd3.nv-noData {
          font-size: 18px;
          font-weight: bold;
      }


      /**********
      *  Brush
      */

      .nv-brush .extent {
          fill-opacity: .125;
          shape-rendering: crispEdges;
      }

      .nv-brush .resize path {
          fill: #eee;
          stroke: #666;
      }


      /**********
      *  Legend
      */

      .nvd3 .nv-legend .nv-series {
          cursor: pointer;
      }

      .nvd3 .nv-legend .nv-disabled circle {
          fill-opacity: 0;
      }

      /* focus */
      .nvd3 .nv-brush .extent {
          fill-opacity: 0 !important;
      }

      .nvd3 .nv-brushBackground rect {
          stroke: #000;
          stroke-width: .4;
          fill: #fff;
          fill-opacity: .7;
      }

      /**********
      *  Print
      */

      @media print {
        .nvd3 text {
          stroke-width: 0;
          fill-opacity: 1;
        }
      }

      .nvd3 .background path {
          fill: none;
          stroke: #EEE;
          stroke-opacity: .4;
          shape-rendering: crispEdges;
      }

      .nvd3 .foreground path {
          fill: none;
          stroke-opacity: .7;
      }

      .nvd3 .nv-parallelCoordinates-brush .extent
      {
          fill: #fff;
          fill-opacity: .6;
          stroke: gray;
          shape-rendering: crispEdges;
      }

      .nvd3 .nv-parallelCoordinates .hover  {
          fill-opacity: 1;
      	stroke-width: 3px;
      }


      .nvd3 .missingValuesline line {
        fill: none;
        stroke: black;
        stroke-width: 1;
        stroke-opacity: 1;
        stroke-dasharray: 5, 5;
      }

      /* scatter */
      .nvd3 .nv-groups .nv-point.hover {
          stroke-width: 20px;
          stroke-opacity: .5;
      }

      .nvd3 .nv-scatter .nv-point.hover {
          fill-opacity: 1;
      }
      .nv-noninteractive {
          pointer-events: none;
      }

      .nv-distx, .nv-disty {
          pointer-events: none;
      }


      .nvd3 .nv-hoverArea {
          fill-opacity: 0;
          stroke-opacity: 0;
      }

      /* stacked area */
      .nvd3.nv-stackedarea path.nv-area {
          fill-opacity: .7;
          stroke-opacity: 0;
          transition: fill-opacity 250ms linear, stroke-opacity 250ms linear;
          -moz-transition: fill-opacity 250ms linear, stroke-opacity 250ms linear;
          -webkit-transition: fill-opacity 250ms linear, stroke-opacity 250ms linear;
      }

      .nvd3.nv-stackedarea path.nv-area.hover {
          fill-opacity: .9;
      }


      .nvd3.nv-stackedarea .nv-groups .nv-point {
          stroke-opacity: 0;
          fill-opacity: 0;
      }

      .nvd3 .nv-interactiveGuideLine {
          pointer-events:none;
      }
      .nvd3 line.nv-guideline {
          stroke: #ccc;
      }

      .nvd3 .nv-axis path {
          fill: none;
          stroke: #b6b6b6;
          stroke-opacity: .75;
          shape-rendering: crispEdges;
      }

      .nv-x .tick line {
        display: none;
      }

      .nv-y .tick line {
        stroke:#b6b6b6;
      }

  		.nvd3 text {
  			fill:#e0e0e0;
  		}

      .nvd3.nv-noData {
  			fill: #e0e0e0;
  		}
    </style>

    <iron-pages selected="[[selectedPage]]">
      <div id="loading">
        <span>Loading&nbsp;</span>
        <paper-spinner active></paper-spinner>
      </div>
      <div id="noData"><span>No data</span></div>
      <div id="canvas"></div>
    </iron-pages>
  </template>
</dom-module>

<script>

(function() {

  Polymer({
    is: 'bnb-chart',

    properties: {
      chart: {
        notify: true
      },
      data: {
        type: Object,
        value: function () {
          return null;
        }
      },
      model: {
        type: Array,
        value: function () {
          return [];
        }
      },
      symbol: {
        type: String,
        value: ''
      },
      stacked: {
        type: Boolean,
        value: false
      },
      selectedPage: {
        type: Number,
        value: 0
      }
    },

    observers: [
      'updateChart(data.*)'
    ],

    behaviors: [
      Polymer.IronResizableBehavior
    ],

    listeners: {
      'iron-resize': 'onIronResize'
    },

    onIronResize: function() {
      if (this.chart) {
        this.chart.update();
      }
    },

    updateChart: function() {
      if (this.data) {
        if (this.hasValues(this.data)) {
          this.selectedPage = 2;
        }
        else {
          this.selectedPage = 1;
        }
      }
      else {
        this.selectedPage = 0;
      }

      if (this.data && this.hasValues(this.data)) {
        var chartData = this.createChartData();

        if (this.chart) {
          if (!_.isEqual(this.oldData, this.data)) {
            var lines = d3.select(this.$.canvas).selectAll("svg");
            this.updateChartTickFormat(this.chart, chartData);
            lines.datum(chartData).transition().duration(500).call(this.chart);

            this.oldData = this.data;
          }
        }
        else {
          if (this.stacked) {
            this.chart = nv.models.stackedAreaChart();
            this.chart.showControls(false);
          }
          else {
            this.chart = nv.models.lineChart();
            this.chart.forceY([0]);
          }
          this.chart.margin({left: 40, right: 10});
          this.chart.useInteractiveGuideline(true);
          this.chart.duration(500);

          this.chart.showLegend(true);
          this.updateChartTickFormat(this.chart, chartData);
          this.chart.xAxis.showMaxMin(false);

          this.chart.yAxis.tickFormat(d3.format(this.symbol + ',.0'));
          this.chart.yAxis.showMaxMin(false);
          this.chart.yAxis.ticks(5);

          d3.select(this.$.canvas).append('svg')
            .datum(chartData)
            .call(this.chart);
            nv.utils.windowResize(this.chart.update);
        }
      }

      // Apply svg styles
      this.scopeSubtree(this.$.canvas, true);
    },

    hasValues: function(data) {
      var resu = false;
      for (var i = 0; i < data.length && !resu; i++) {
        resu = data[i].values.length > 0;
      }
      return resu;
    },

    createChartData: function() {
      var resu = [];
      for (var i = 0; i < this.model.length; i++) {
        var serie = {};
        serie.key = this.model[i].label;
        serie.color = this.model[i].color;
        serie.fillOpacity = 0.2;
        serie.area = true;
        serie.values = this.createValues(this.model[i].name);
        resu.push(serie);
      }
      return resu;
    },

    updateChartTickFormat: function(chart, data) {
      var tickFormat = this.computeTickFormat(data);
      chart.xAxis.tickFormat(function(d) {
        return d3.time.format(tickFormat)(new Date(d));
      });
    },

    createValues: function(key) {
      var item = _.find(this.data, function(i) { return i.key === key; });
  		var resu = [];
      if (item) {
    		for (var i = 0; i < item.values.length; i++) {
    			var time = new Date(item.values[i].time);
    			resu.push( {x: time, y: item.values[i].value});
    		}
      }
  		return resu;
  	},

    computeTickFormat: function(chartData) {
      var resu = '%x';
      if (chartData.length > 0) {
        var serie = chartData[0];
        var first = serie.values[0].x;
        var last  = serie.values[serie.values.length-1].x;
        if ( (last - first) < (7*24*60*60*1000)) {
          resu = '%x %H:%M';
        }
      }
      return resu;
    }
  });

})();
</script>
