<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bnb-value-chip.html">
<link rel="import" href="bnb-chart.html">

<dom-module id="bnb-chart-card">
  <style>
    :host {
      display:flex;
      margin:16px;
    }

    paper-card {
      width: 100%;
    }

    #chips {
      @apply(--layout-horizontal);
      @apply(--layout-wrap);
      text-align: center;
      align-items: stretch;
    }

    bnb-value-chip {
      flex: 1;
    }

    #chart {
      height: 340px;
      width: 100%;
    }

  </style>
  <template>
    <paper-card heading="[[name]]">
      <div class="card-content">
        <div id="chips">
          <template is="dom-repeat" id="values" items="[[getData(data)]]">
            <bnb-value-chip text="[[computeLabel(item)]]" value="[[item.summary]]" suffix="[[computeSuffix(item)]]">
            </bnb-value-chip>
          </template>
        </div>
        <bnb-chart id="chart" stacked="[[stacked]]" data="[[getData(data)]]" model="[[model]]"></bnb-chart>
      </div>
      <div class="card-actions" hidden$="[[hasNoDomain(data)]]">
        <paper-tabs selected="0" style="width:100px">
          <paper-tab on-tap="desktopTapped">
            <iron-icon icon="hardware:computer"></iron-icon>
          </paper-tab>
          <paper-tab on-tap="mobileTapped">
            <iron-icon icon="hardware:smartphone"></iron-icon>
          </paper-tab>
        </paper-tabs>
      </div>
    </paper-card>
  </template>
</dom-module>
<script>

(function() {

  Polymer({
    is: 'bnb-chart-card',

    properties: {
      name: {
        type: String,
        value: ''
      },
      data: {
        type: Object,
        value: function () {
          return {};
        }
      },
      model: {
        type: Array,
        value: function () {
          return [];
        }
      },
      stacked: {
        type: Boolean,
        value: false
      },
      target: {
        type: String,
        value: 'desktop'
      }
    },

    hasNoDomain: function(data) {
      if (this.data) {
        return this.data instanceof Array;
      }
      return true;
    },

    getData: function() {
      if (this.data) {
        if (this.data instanceof Array) {
          return this.data;
        }
        else {
          return this.data[this.target];
        }
      }
      return undefined;
    },

    computeLabel: function(o) {
      var item = _.find(this.model, function(i) { return i.name === o.key; });
      if (item) {
        return item.label;
      }
      return "";
    },

    computeSuffix: function(o) {
      var item = _.find(this.model, function(i) { return i.name === o.key; });
      if (item) {
        return item.suffix;
      }
      return "";
    },

    desktopTapped: function() {
      this.switchToTarget("desktop");
    },

    mobileTapped: function() {
      this.switchToTarget("mobile");
    },

    switchToTarget: function(newTarget) {
      if (this.target !== newTarget) {
        this.target = newTarget;
        this.$.values.items = this.data[this.target];
        this.$.chart.data = this.data[this.target];
      }
    }
  });

})();
</script>
