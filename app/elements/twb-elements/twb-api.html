<dom-module id="twb-api">
  <template>

  <iron-ajax id="signin-ajax"
      url="/api/v1/users/sign_in.json"
      method="POST"
      handle-as="json"></iron-ajax>

  <iron-ajax id="signup-ajax"
      url="/api/v1/users.json"
      method="POST"
      handleAs="json"
      params='{"user[name]":"{{user.name}}", "user[email]":"{{user.email}}", "user[password]":"{{user.password}}", "user[password_confirmation]":"{{user.password_confirmation}}"}'
      on-core-response="handleSignupResponse"
      on-core-error="handleSignupError"></iron-ajax>

  <iron-ajax id="forgot-ajax"
      url="/api/v1/users/password.json"
      method="POST"
      handleAs="json"
      params='{"user[email]":"{{user.email}}"}'
      on-core-response="handleForgotResponse"
      on-core-error="handleForgotError"></iron-ajax>

  </template>
</dom-module>

<script>

Polymer({
  is: 'twb-api', 


  isLogged: function() {
    return sessionStorage.getItem('accessToken') !== null;
  },

  signin: function(params, successCallback, errorCallback, callbackObj) {
    var options = this._generateOptions("/auth/sign_in", "POST", params);
    this._sendRequest(options, successCallback, errorCallback, callbackObj);
  },

  signup: function(params, successCallback, errorCallback, callbackObj) {
    var options = this._generateOptions("/auth/", "POST", params);
    this._sendRequest(options, successCallback, errorCallback, callbackObj);
  },

  signout: function() {
    sessionStorage.removeItem('accessToken');
  },

  forgotPassword: function(params, successCallback, errorCallback, callbackObj) {
    var options = this._generateOptions("/auth/password", "POST", params);
    this._sendRequest(options, successCallback, errorCallback, callbackObj);
  },

  updatePassword: function(params, headers, successCallback, errorCallback, callbackObj) {
    var options = this._generateOptions("/auth/password", "PUT", params, headers);
    this._sendRequest(options, successCallback, errorCallback, callbackObj);
  },

  _generateOptions: function(url, method, params, headers) {
    var options = {
      url: this._getRequestUrl(url, params),
      method: method,
      headers: this._getRequestHeaders(headers),
      body: "",
      async: true,
      handleAs: "json",
      withCredentials: false
    };
    return options;
  },

  _sendRequest: function(options, successCallback, errorCallback, callbackObj) {
    var req = document.createElement('iron-request');
    req.completes.then(
      this._handleSuccess.bind(this, req, successCallback, callbackObj)
    ).catch(
      this._handleError.bind(this, req, errorCallback, callbackObj)
    );

    req.send(options);
  },

  _handleSuccess: function(request, callback, callbackObj) {
    var accessToken = request.xhr.getResponseHeader('access-token');
    sessionStorage.setItem('accessToken', accessToken);
    callback.apply (callbackObj, [request.xhr.response]);
  },

  _handleError: function(request, callback, callbackObj, error) {
    callback.apply (callbackObj, [request.xhr.response]);
  },

  _getRequestHeaders: function(headers) {
    var resu = {};
    var header;

    if (headers instanceof Object) {
      for (header in headers) {
        resu[header] = headers[header].toString();
      }
    }

    return resu;
  },

  _getQueryString: function(params) {
    var queryParts = [];
    var param;
    var value;

    for (param in params) {
      value = params[param];
      param = window.encodeURIComponent(param);

      if (value !== null) {
        param += '=' + window.encodeURIComponent(value);
      }

      queryParts.push(param);
    }

    return queryParts.join('&');
  },

  _getRequestUrl: function(url, params) {
    var queryString = this._getQueryString(params);

    if (queryString) {
      return url + '?' + queryString;
    }

    return url;
  }
});
</script>
