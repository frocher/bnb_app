<dom-module id="twb-edit-password">
  <link rel="stylesheet" href="twb-shared.css">
  <style>
    :host {
      @apply(--layout-vertical);
    }

  </style>

  <template>

    <iron-ajax id="update-password-ajax"
        url="/auth/password"
        method="PUT"
        handleAs="json"
        params='{"password":"{{password}}", "password_confirmation":"{{password_confirmation}}", "access-token":"{{token}}", "client":"{{client}}"}'
        on-core-response="handleResponse"
        on-core-error="handleError">
    </iron-ajax>


    <form id="signin-form">
      <h2>Edit your new password</h2>

      <div class="field">
        <paper-input-container>
          <label>Password</label>
          <input is="iron-input" autocomplete="off" type="password" value="{{password}}">
        </paper-input-container>
      </div>

      <div class="field">
        <paper-input-container>
          <label>Password confirmation</label>
          <input autocomplete="off" type="password" value="{{password_confirmation}}">
        </paper-input-container>
      </div>

      <div class="actions" horizontal end-justified layout>
        <paper-button class="colored" on-tap="submitTapped">Change</paper-button>
      </div>
    </form>

    <paper-toast id="edit-toast" text="{{message}}"></paper-toast>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-edit-password',

    ready: function() {
      this.message = "";
      this.token = this.getQueryVariable("token");
      this.client = this.getQueryVariable("client_id");
      this.errors = {};
    },

    submitTapped: function(event, detail, sender) {
      var ajax = this.$["update-password-ajax"];
      ajax.go();
    },

    handleResponse: function(event, response) {
      var responseObject = JSON.parse(response.xhr.response);
      this.showToast(responseObject.message);
    },

    handleError: function(event, response) {
      var responseObject = JSON.parse(response.xhr.response);
      this.showToast(responseObject.errors[0]);
    },

    showToast: function(message) {
      this.message = message;
      var toast = this.$["edit-toast"];
      toast.show();
    },

    getQueryVariable: function(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0;i < vars.length; i++) {
        var pair = vars[i].split("=");
        if(pair[0] == variable) {
          return pair[1];
        }
      }
      return undefined;
    }

  });

})();

</script>
