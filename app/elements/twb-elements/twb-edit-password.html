<dom-module id="twb-edit-password">
  <link rel="stylesheet" href="twb-shared.css">
  <style>
    :host {
      @apply(--layout-vertical);
    }
  </style>

  <template>
    <twb-api id="api"></twb-api>

    <iron-ajax id="update-password-ajax"
        url="/auth/password"
        method="PUT"
        handle-as="json"
        on-response="handleResponse"
        on-error="handleError">
    </iron-ajax>

    <twb-auth-form id="edit-form" title="Edit your new passwords">

      <paper-input id="password" label="Password" type="password" value="{{params.password}}">
      </paper-input>

      <paper-input id="password_confirmation" label="Password confirmation" autocomplete="off" type="password" value="{{params.password_confirmation}}">
      </paper-input>

      <div class="actions">
        <iron-pages selected="0">
          <paper-button class="colored" on-tap="submitTapped">Change</paper-button>
          <paper-button id="goToLoginBtn" on-tap="goLoginTapped">Go to login page</paper-button>
        </iron-pages>
      </div>
    </twb-auth-form>
  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-edit-password',

    ready: function() {
      this.params = { password:"", password_confirmation: "" };
      this.errors = {};
    },

    submitTapped: function(event, detail, sender) {
      this.$["password"].invalid = false;
      this.$["password_confirmation"].invalid = false;

      var headers = { 'access-token': this.getQueryVariable("token"), client: this.getQueryVariable("client_id"), uid: this.getQueryVariable("uid") };
      var api = this.$.api;
      api.updatePassword(this.params, headers, this.handleResponse, this.handleError, this);
    },

    goLoginTapped: function() {
       MoreRouting.navigateTo('/users/signin');
    },

    handleResponse: function(data) {
      this.showToast(data.message);

      var pages = document.querySelector('iron-pages');
      pages.select("1");
    },

    handleError: function(error) {
      var errors = error.errors;
      if (errors[0] !== undefined) {
        this.showToast(errors[0]);
      }
      else {
        for (var prop in errors) {
          if (errors.hasOwnProperty(prop)) {
            var objId = "" + prop;
            if (this.$[objId] !== undefined) {
              this.$[objId].invalid = true;
              this.$[objId].errorMessage = errors[prop][0];
            }
          }
        }       
      }
    },

    showToast: function(message) {
      this.fire('message', {message: message});
    },

    getQueryVariable: function(variable) {
      var hrefPart = window.location.href;
      var query = hrefPart.substring(hrefPart.indexOf('?') + 1);
      var vars = query.split("&");
      for (var i = 0;i < vars.length; i++) {
        var pair = vars[i].split("=");
        if(pair[0] == variable) {
          return decodeURIComponent(pair[1]);
        }
      }
      return undefined;
    }

  });

})();

</script>
