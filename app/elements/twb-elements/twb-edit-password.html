<dom-module id="twb-edit-password">
  <link rel="stylesheet" href="twb-shared.css">
  <style>
    :host {
      @apply(--layout-vertical);
    }

  </style>

  <template>

    <iron-ajax id="update-password-ajax"
        url="/auth/password"
        method="PUT"
        handle-as="json"
        on-core-response="handleResponse"
        on-core-error="handleError">
    </iron-ajax>

    <twb-auth-form id="edit-form" title="Edit your new passwords">

      <paper-input label="Password" type="password" value="{{params.password}}">
      </paper-input>

      <paper-input label="Password confirmation" autocomplete="off" type="password" value="{{params.password_confirmation}}">
      </paper-input>

      <div class="actions">
        <paper-button class="colored" on-tap="submitTapped">Change</paper-button>
      </div>
    </twb-auth-form>

    <paper-toast id="edit-toast"></paper-toast>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-edit-password',

    ready: function() {
      this.params = { password:"", password_confirmation: "", 'access-token': this.getQueryVariable("token"), client: this.getQueryVariable("client_id") };
      this.errors = {};
    },

    submitTapped: function(event, detail, sender) {
      var ajax = this.$["update-password-ajax"];
      ajax.params = this.params;
      ajax.generateRequest();
    },

    handleResponse: function(event, response) {
      var responseObject = JSON.parse(response.xhr.response);
      this.showToast(responseObject.message);
    },

    handleError: function(event, response) {
      var responseObject = JSON.parse(response.xhr.response);
      this.showToast(responseObject.errors[0]);
    },

    showToast: function(message) {
      var toast = this.$["edit-toast"];
      toast.text = message;
      toast.show();
    },

    getQueryVariable: function(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i = 0;i < vars.length; i++) {
        var pair = vars[i].split("=");
        if(pair[0] == variable) {
          return pair[1];
        }
      }
      return undefined;
    }

  });

})();

</script>
