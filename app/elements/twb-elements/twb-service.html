<script>

(function(scope) {
var TwbService = scope.TwbService = scope.TwbService || {};


TwbService.isLogged = function isLogged() {
  return sessionStorage.getItem('accessToken') !== null;
};

TwbService.signin = function signin(params, successCallback, errorCallback, callbackObj) {
  var options = TwbService._generateOptions("/auth/sign_in", "POST", params);
  TwbService._sendRequest(options, successCallback, errorCallback, callbackObj);
};

TwbService.signup = function signup(params, successCallback, errorCallback, callbackObj) {
  var options = TwbService._generateOptions("/auth/", "POST", params);
  TwbService._sendRequest(options, successCallback, errorCallback, callbackObj);
};

TwbService.signout = function signout() {
  sessionStorage.removeItem('accessToken');
};

TwbService.forgotPassword = function forgotPassword(params, successCallback, errorCallback, callbackObj) {
  var options = TwbService._generateOptions("/auth/password", "POST", params);
  TwbService._sendRequest(options, successCallback, errorCallback, callbackObj);
};

TwbService.updatePassword = function updatePassword(params, headers, successCallback, errorCallback, callbackObj) {
  var options = TwbService._generateOptions("/auth/password", "PUT", params, headers);
  TwbService._sendRequest(options, successCallback, errorCallback, callbackObj);
};

TwbService.loadSites = function loadSites(params, successCallback, errorCallback, callbackObj) {
  var options = TwbService._generateOptions("/api/v1/sites", "GET", params);
  TwbService._sendRequest(options, successCallback, errorCallback, callbackObj);
};

TwbService._generateOptions = function _generateOptions(url, method, params, headers) {
  var options = {
    url: TwbService._getRequestUrl(url, params),
    method: method,
    headers: {'access-token' : TwbService._getAccessToken()} || TwbService._getRequestHeaders(headers),
    body: "",
    async: true,
    handleAs: "json",
    withCredentials: false
  };
  return options;
};

TwbService._sendRequest = function _sendRequest(options, successCallback, errorCallback, callbackObj) {
  var req = document.createElement('iron-request');
  _this = this;
  req.completes.then( function(result) {
    _this._handleSuccess(req, successCallback, callbackObj);
  }, function(err) {
    _this._handleSuccess(req, errorCallback, callbackObj);
  });
  req.send(options);
};

TwbService._handleSuccess = function _handleSuccess(request, callback, callbackObj) {
  var accessToken = request.xhr.getResponseHeader('access-token');
  TwbService._setAccessToken(accessToken);
  callback.apply (callbackObj, [request.xhr.response]);
};

TwbService._handleError = function _handleError(request, callback, callbackObj, error) {
  callback.apply (callbackObj, [request.xhr.response]);
};

TwbService._getRequestHeaders = function _getRequestHeaders(headers) {
  var resu = {};
  var header;

  if (headers instanceof Object) {
    for (header in headers) {
      resu[header] = headers[header].toString();
    }
  }

  return resu;
};

TwbService._getQueryString = function _getQueryString(params) {
  var queryParts = [];
  var param;
  var value;

  for (param in params) {
    value = params[param];
    param = window.encodeURIComponent(param);

    if (value !== null) {
      param += '=' + window.encodeURIComponent(value);
    }

    queryParts.push(param);
  }

  return queryParts.join('&');
};

TwbService._getRequestUrl = function _getRequestUrl(url, params) {
  var queryString = TwbService._getQueryString(params);

  if (queryString) {
    return url + '?' + queryString;
  }

  return url;
};

TwbService._getAccessToken = function _getAccessToken() {
  return sessionStorage.getItem('accessToken');
};

TwbService._setAccessToken = function _setAccessToken(token) {
  sessionStorage.setItem('accessToken', token);
};

})(window);
</script>
