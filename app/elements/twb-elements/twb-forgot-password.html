<dom-module id="twb-forgot-password">
  <link rel="stylesheet" href="twb-shared.css">
  <style>
    :host {
      @apply(--layout-vertical);
    }
  </style>

  <template>

  <iron-ajax id="forgot-ajax"
      url="/auth/password"
      method="POST"
      handleAs="json"
      params='{"email":"{{email}}", "redirect_url":"{{editPasswordUrl()}}"}'
      on-core-response="handleResponse"
      on-core-error="handleError">
  </iron-ajax>

  <twb-auth-form id="forgot-form" title="Password forgotten" buttons="{{forgotButtons}}">
    <paper-input-container id="forgot-email">
      <label>E-mail</label>
      <input is="iron-input" type="email" value="{{email}}">
    </paper-input-container>

    <div class="actions" horizontal end-justified layout>
      <paper-button class="colored" on-tap="submitTapped">Reset password</paper-button>
    </div>
  </form>

  <paper-toast id="forgot-toast" text="{{message}}"></paper-toast>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-forgot-password',

    ready: function() {
      this.message = "";
      this.forgotButtons = [{text:'Sign up', path:'signup'}, {text:'Sign in', path:'signin'}];
    },

    editPasswordUrl: function() {
      return window.location.protocol + "//" + window.location.host + MoreRouting.urlFor("editPassword") + "/"; 
    },

    submitTapped: function(event, detail, sender) {
      this.$["forgot-email"].isInvalid = false;
      var ajax = this.$["forgot-ajax"];
      ajax.go();
    },

    handleResponse: function(event, response) {
      var successObject = JSON.parse(response.xhr.response);
      this.showToast(successObject.message);
    },

    handleError: function(event, response) {
      var errorObject = JSON.parse(response.xhr.response);
      this.showToast(errorObject.errors[0]);
    },

    showToast: function(message) {
      this.message = message;
      var toast = this.$["edit-toast"];
      toast.show();
    }
  });

})();

</script>
