<link rel="import" href="twb-app.html">
<link rel="import" href="twb-signin.html">

<dom-module id="twb-wrapper">
  <style>
    :host {
      @apply(--layout-vertical);
    }

    .pages {
      @apply(--layout-fit);
    }

    .page {
      @apply(--layout-fit);
    }
  </style>
  <template>

    <more-route-selector>
      <neon-animated-pages id="pages" class="pages" transitions="cross-fade-all">
        <section name="splash" class="page" route="splash">
        </section>
        <twb-app name="app" class="page" route="home"></twb-app>
        <twb-signin name="signin" class="page" route="users"></twb-signin>
      </neon-animated-pages>
    </more-route-selector>
    <paper-toast id="message-toast"></paper-toast>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-wrapper', 

    listeners: {
      message: 'handleMessage'
    },

    ready: function() {
      _this = this;

      if (!MoreRouting.isCurrentUrl("/users")) {
        if (!TwbService.isLogged()) {
          MoreRouting.navigateTo('/users/signin');
        }
        else {
          this.loadSites();
        }
      }
      
      this.$.pages.querySelector('twb-signin').addEventListener('signedin', function(e) {
        _this.loadSites();
        MoreRouting.navigateTo('home');
      });

      this.$.pages.querySelector('twb-signin').addEventListener('signedup', function(e) {
        _this.loadSites();
        MoreRouting.navigateTo('home');
      });

      this.$.pages.querySelector('twb-app').addEventListener('signedout', function(e) {
        MoreRouting.navigateTo('/users/signin');
      });
    },

    loadSites: function() {
      TwbService.loadSites({}, this.handleLoadSitesResponse, this.handleLoadSitesError, this);
    },

    handleLoadSitesResponse: function(data) {
      TwbSiteStore.sites = data;
    },

    handleLoadSitesError: function(error) {
      this.showToast(error.errors[0]);
    },

    handleMessage: function(e) {
      var toast = this.$["message-toast"];
      toast.text = e.detail.message;
      toast.show();
    }


  });

})();
</script>

