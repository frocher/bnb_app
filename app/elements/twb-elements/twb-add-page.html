<dom-module id="twb-add-page">
  <style>
    :host {
      @apply(--layout-vertical);
    }

    #content {
      padding: 10px 22px 10px 22px;
      background-color: #fff;
    }

  </style>
  <template>
    <paper-header-panel class="flex">
      <paper-toolbar>
        <paper-icon-button icon="close" on-tap="closeTapped"></paper-icon-button>
        <span class="title">New page</span>
        <span class="flex"></span>
        <paper-button on-tap="createTapped">Create</paper-button>
      </paper-toolbar>
      <div id="content" class="fit">
        <paper-input id="name" label="Page name" value="{{params.name}}"></paper-input>
        <paper-input id="url" label="URL" value="{{params.url}}"></paper-input>

        <paper-dialog id="discardDlg" modal>
          <p>Discard new page.</p>
          <div class="buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm autofocus on-tap="closePage">Discard</paper-button>
          </div>
        </paper-dialog>
      </div>
    </paper-header-panel>


  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-add-page',

    properties: {
      pages: {
        type: Array,
        value: function() {
          return [];
        }
      }
    },

    ready: function() {
      this.clearFields();
    },

    closeTapped: function() {
      if (this.params.name !== '' || this.params.url !== '') {
        this.$.discardDlg.open();
      }
      else {
        this.closePage();
      }

    },

    closePage: function() {
      this.clearFields();
      TwbActions.showPageList();
    },

    createTapped: function() {
      this.$['name'].invalid = false;
      this.$['url'].invalid = false;

      TwbService.createPage(this.params, this.handleResponse, this.handleError, this);
    },

    handleResponse: function(data) {
      this.push('pages', data);
      this.closePage();
    },

    handleError: function(error) {
      if (error === null) {
        TwbActions.showMessage("Error : can't create page");
      }
      else {
        var errors = error.errors;
        for (var prop in errors) {
          if (errors.hasOwnProperty(prop)) {
            var objId = prop;
            if (this.$[objId] !== undefined) {
              this.$[objId].invalid = true;
              this.$[objId].errorMessage = errors[prop][0];
            }
          }
        }       
      }
    },

    clearFields: function() {
      this.params = {name: '', url: ''};      
    }

  });

})();
</script>

