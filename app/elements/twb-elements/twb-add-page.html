<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">

<dom-module id="twb-add-page">
  <style>
    :host {
      @apply(--layout-vertical);
    }

    #content {
      padding: 10px 22px 10px 22px;
    }

  </style>
  <template>
    <iron-a11y-keys keys="enter" target="[[target]]" on-keys-pressed="createTapped">
    </iron-a11y-keys>
    <paper-header-panel class="flex">
      <paper-toolbar>
        <paper-icon-button icon="close" on-tap="closeTapped"></paper-icon-button>
        <span class="title">New page</span>
        <span class="flex"></span>
        <paper-button on-tap="createTapped">Create</paper-button>
      </paper-toolbar>
      <div id="content" class="fit">
        <paper-input id="name" label="Page name" value="{{params.name}}" autofocus="true"></paper-input>
        <paper-input id="url" label="URL" value="{{params.url}}"></paper-input>
      </div>
    </paper-header-panel>

    <paper-dialog id="discardDlg" modal>
      <p>Discard new page.</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="closePage">Discard</paper-button>
      </div>
    </paper-dialog>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-add-page',

    properties: {
      pages: {
        type: Array,
        value: function() {
          return [];
        }
      },

      target: {
        type: Object,
        value: function() {
          return this.$.content;
        }
      }
    },

    behaviors: [
      Polymer.NeonAnimatableBehavior,
      Polymer.IronResizableBehavior
    ],

    ready: function() {
      this.clearFields();
    },

    closeTapped: function() {
      if (this.params.name !== '' || this.params.url !== '') {
        this.$.discardDlg.open();
      }
      else {
        this.closePage();
      }
    },

    createTapped: function() {
      this.$['name'].invalid = false;
      this.$['url'].invalid = false;

      TwbService.createPage(this.params, this.handleResponse, this.handleError, this);
    },

    handleResponse: function(data) {
      this.fire('page-created', {page: data});
      this.clearFields();
    },

    handleError: function(error) {
      if (error === null) {
        this.fire('message', {message: "Error : can't create page"});
      }
      else {
        var errors = error.errors;
        for (var prop in errors) {
          if (errors.hasOwnProperty(prop)) {
            var objId = prop;
            if (this.$[objId] !== undefined) {
              this.$[objId].invalid = true;
              this.$[objId].errorMessage = errors[prop][0];
            }
          }
        }
      }
    },

    clearFields: function() {
      this.$['name'].invalid = false;
      this.$['url'].invalid = false;
      this.params = {name: '', url: ''};
    },

    closePage: function() {
      this.clearFields();
      this.fire('show-pages');
    }

  });

})();
</script>
