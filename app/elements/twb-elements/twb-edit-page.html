<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animation.html">

<dom-module id="twb-edit-page">
  <style>
    :host {
      @apply(--layout-vertical);
    }

    #content {
      padding: 10px 22px 10px 22px;
    }

  </style>
  <template>
    <iron-a11y-keys keys="enter" target="[[target]]" on-keys-pressed="saveTapped">
    </iron-a11y-keys>
    <paper-header-panel class="flex">
      <paper-toolbar>
        <paper-icon-button icon="close" on-tap="closeTapped"></paper-icon-button>
        <span class="title">Edit page</span>
        <span class="flex"></span>
        <paper-button on-tap="saveTapped">Save</paper-button>
      </paper-toolbar>
      <div id="content" class="fit">
        <paper-input id="name" label="Page name" value="[[page.name]]" autofocus="true"></paper-input>
        <paper-input id="url" label="URL" value="[[page.url]]"></paper-input>
      </div>

      <paper-dialog id="discardDlg" modal>
        <p>Discard edit.</p>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm autofocus on-tap="closePage">Discard</paper-button>
        </div>
      </paper-dialog>
    </paper-header-panel>


  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-edit-page',

    properties: {
      page: {
        type: Object,
        value: null
      },
      target: {
        type: Object,
        value: function() {
          return this.$.content;
        }
      }
    },

    behaviors: [
      Polymer.NeonAnimatableBehavior,
      Polymer.IronResizableBehavior
    ],
    
    closeTapped: function() {
      if (this.$['name'].value !== this.page.name || this.$['url'].value !== this.page.url) {
        this.$.discardDlg.open();
      }
      else {
        this.closePage();
      }
    },

    closePage: function() {
      this.$['name'].invalid = false;
      this.$['url'].invalid = false;
      this.fire('show-page', {page: this.page});
    },

    saveTapped: function() {
      this.$['name'].invalid = false;
      this.$['url'].invalid = false;

      var page = {
        name: this.$['name'].value,
        url: this.$['url'].value
      }

      TwbService.updatePage(this.page.id, page, this.handleResponse, this.handleError, this);
    },

    handleResponse: function(data) {
      this.page = data;
      this.fire('message', {message: "Page has been updated"});
      this.closePage();
    },

    handleError: function(error) {
      if (error === null) {
        this.fire('message', {message: "Error : can't save page"});
      }
      else {
        var errors = error.errors;
        for (var prop in errors) {
          if (errors.hasOwnProperty(prop)) {
            var objId = prop;
            if (this.$[objId] !== undefined) {
              this.$[objId].invalid = true;
              this.$[objId].errorMessage = errors[prop][0];
            }
          }
        }
      }
    }

  });

})();
</script>
