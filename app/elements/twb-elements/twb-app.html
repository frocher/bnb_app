<link rel="import" href="twb-signin.html">
<link rel="import" href="twb-signup.html">
<link rel="import" href="twb-forgot-password.html">
<link rel="import" href="twb-edit-password.html">
<link rel="import" href="twb-pages.html">
<link rel="import" href="twb-page.html">
<link rel="import" href="twb-add-page.html">

<dom-module id="twb-app">
  <style>
    :host {
      @apply(--layout-vertical);
    }

    .page {
      @apply(--layout-fit);
    }
  </style>

  <template>

    <iron-pages class="page" attr-for-selected="data-route" selected="{{route}}">
      <section             id="splash"       class="page" data-route="splash"></section>
      <twb-signin          id="signin"       class="page" data-route="signin"></twb-signin>
      <twb-signup          id="signup"       class="page" data-route="signup"></twb-signup>
      <twb-forgot-password id="forgot"       class="page" data-route="forgot"></twb-forgot-password>
      <twb-edit-password   id="editPassword" class="page" data-route="edit-password"></twb-edit-password>
      <twb-pages           id="pages"        class="page" data-route="home" pages="{{pages}}"></twb-pages>
      <twb-page            id="page"         class="page" data-route="page" page="{{currentPage}}"></twb-page>
      <twb-add-page        id="addPage"      class="page" data-route="add-page" pages="{{pages}}"></twb-add-page>
    </iron-pages>

    <paper-toast id="message-toast"></paper-toast>

  </template>
</dom-module>

<script>
(function() {

  Polymer({

    is: 'twb-app', 

    listeners: {
      'message': 'handleMessage',
      'signedin': 'handleSignedIn', 
      'signedout': 'handleSignedOut',
      'page-selected': 'handlePageSelected'
    },

    properties: {
      pages: {
        type: Array,
        value: function() {
          return [];
        }
      },

      currentPage : {
        type: Object,
        value: null     
      }
    },

    ready: function() {
      var _this = this;

      this._initRoutes();

      if (TwbService.isLogged()) {
        this._initData();
      }
    },

    loadPages: function() {
      TwbService.loadPages({}, this.handleLoadPagesResponse, this.handleLoadPagesError, this);
    },

    handleLoadPagesResponse: function(data) {
      this.pages = data;
    },

    handleLoadPagesError: function(error) {
      this.showToast(error.errors[0]);
    },

    handleMessage: function(e) {
      this.showToast(e.detail.message);
    },

    handlePageSelected: function(e) {
      var path = '/page/' + e.detail.page.id;
      page(path);
    },

    handleSignedIn: function(e) {
      this.loadPages();
      page('/');
    },

    handleSignedOut: function(e) {
      // TODO : invalidate credentials
      page('/signin');
    },

    showToast: function(message) {
      var toast = this.$['message-toast'];
      toast.text = message;
      toast.show();
    },

    _initData : function() {
      this.loadPages();
    },

    _initRoutes: function() {
      var _this = this;

      page('/signin', function () {
        _this.route = 'signin';
      });

      page('/signup', function () {
        _this.route = 'signup';
      });

      page('/forgot', function () {
        _this.route = 'forgot';
      });

      page('/edit-password', function () {
        _this.route = 'edit-password';
      });

      page('/', function () {
        if (!TwbService.isLogged()) {
          page.redirect('/signin');
        }
        else {
          _this.route = 'home';
        }
      });

      page('/page/:id', function (context) {
        if (!TwbService.isLogged()) {
          page.redirect('/signin');
        }
        else {
          // TODO : load page details
          var id = context.params.id;
          var found = _.select(_this.pages, function( item ) {
            return item.id == id;
          });
          if (found.length > 0) {
            _this.currentPage = found[0];
          }
          _this.route = 'page';
        }
      });

      page('/add-page', function () {
        if (!TwbService.isLogged()) {
          page.redirect('/signin');
        }
        else {
          _this.route = 'add-page';
        }
      });

      page({
        hashbang: true
      });
    }

  });

})();
</script>
