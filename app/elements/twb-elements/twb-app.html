<link rel="import" href="twb-signin.html">
<link rel="import" href="twb-signup.html">
<link rel="import" href="twb-forgot-password.html">
<link rel="import" href="twb-edit-password.html">
<link rel="import" href="twb-pages.html">
<link rel="import" href="twb-page.html">
<link rel="import" href="twb-add-page.html">
<link rel="import" href="twb-edit-page.html">

<dom-module id="twb-app">
  <style>
    :host {
      @apply(--layout-vertical);
    }

    .page {
      @apply(--layout-fit);
    }
  </style>

  <template>

    <iron-pages class="page" attr-for-selected="data-route" selected="{{route}}">
      <section             id="splash"       class="page" data-route="splash"></section>
      <twb-signin          id="signin"       class="page" data-route="signin"></twb-signin>
      <twb-signup          id="signup"       class="page" data-route="signup"></twb-signup>
      <twb-forgot-password id="forgot"       class="page" data-route="forgot"></twb-forgot-password>
      <twb-edit-password   id="editPassword" class="page" data-route="edit-password"></twb-edit-password>
      <twb-pages           id="pages"        class="page" data-route="home" pages="{{pages}}"></twb-pages>
      <twb-add-page        id="addPage"      class="page" data-route="add-page" pages="{{pages}}"></twb-add-page>
      <twb-page            id="page"         class="page" data-route="page" page="{{page}}"></twb-page>
      <twb-edit-page       id="editPage"     class="page" data-route="edit-page" page="{{page}}"></twb-edit-page>
    </iron-pages>

    <paper-toast id="message-toast"></paper-toast>

  </template>
</dom-module>

<script>
(function() {

  Polymer({
    is: 'twb-app',

    listeners: {
      'message'      : 'handleMessage',
      'signedin'     : 'handleSignedIn',
      'signedout'    : 'handleSignedOut',
      'show-pages'   : 'handleShowPages',
      'show-page'    : 'handleShowPage',
      'edit-page'    : 'handleEditPage',
      'page-created' : 'handlePageCreated',
      'page-deleted' : 'handlePageDeleted'
    },

    properties: {
      pages: {
        type: Array,
        value: function() {
          return [];
        }
      },

      user: {
        type: Object,
        value: null
      },

      page: {
        type: Object,
        value: null
      },

      period: {
        type: String,
        value: null
      },

      customPeriod: {
        type: Object,
        value: null
      }
    },

    loadPages: function() {
      TwbService.loadPages({}, this.handleLoadPagesResponse, this.handleGenericError, this);
    },

    loadPage: function(id) {
      TwbService.loadPage(id, {}, this.handleLoadPageResponse, this.handleGenericError, this);
    },

    handleLoadPagesResponse: function(data) {
      this.pages = data;
    },

    handleLoadPageResponse: function(data) {
      this.page = data;

      // TODO :replace with real selection
      var periodStart = '2015-11-01';
      var periodEnd   = '2015-11-30';

      TwbService.loadUptimes(this.page.id, 'median', periodStart, periodEnd, this.handleLoadUptimeResponse, this.handleGenericError, this);
      TwbService.loadChecks(this.page.id, 'median', periodStart, periodEnd, this.handleLoadCheckResponse, this.handleGenericError, this);
      TwbService.loadUptimes(this.page.id, 'points', periodStart, periodEnd, this.handleLoadUptimesResponse, this.handleGenericError, this);
      TwbService.loadChecks(this.page.id, 'points', periodStart, periodEnd, this.handleLoadChecksResponse, this.handleGenericError, this);
    },

    handleLoadUptimeResponse: function(data) {
      this.page.uptime = Math.round(data[0].value * 100) / 100;
      this.notifyPath('page.uptime', this.page.uptime);
    },

    handleLoadUptimesResponse: function(data) {
      var arrayLength = data.length;
      for (var i = 0; i < arrayLength; i++) {
        data[i].value = Math.round(data[i].value * 100) / 100;
      }
      this.page.uptimes = data;
      this.notifyPath('page.uptimes', this.page.uptimes);
    },

    handleLoadCheckResponse: function(data) {
      this.page.domReady = Math.round(data[0].dom_ready);
      this.page.firstPaint = Math.round(data[0].first_paint);
      this.page.pageLoad = Math.round(data[0].page_load);
      this.page.responseStart = Math.round(data[0].response_start);
      this.page.speedIndex = Math.round(data[0].speed_index);
      this.notifyPath('page.domReady', this.page.domReady);
      this.notifyPath('page.firstPaint', this.page.firstPaint);
      this.notifyPath('page.pageLoad', this.page.pageLoad);
      this.notifyPath('page.responseStart', this.page.responseStart);
      this.notifyPath('page.speedIndex', this.page.speedIndex);
    },

    handleLoadChecksResponse: function(data) {
      this.page.domReadies     = [];
      this.page.firstPaints    = [];
      this.page.pageLoads      = [];
      this.page.responseStarts = [];
      this.page.speedIndexes   = [];
      var arrayLength = data.length;
      for (var i = 0; i < arrayLength; i++) {
        this.page.domReadies.push({time: data[i].time, value:Math.round(data[i].dom_ready)});
        this.page.firstPaints.push({time: data[i].time, value:Math.round(data[i].first_paint)});
        this.page.pageLoads.push({time: data[i].time, value:Math.round(data[i].page_load)});
        this.page.responseStarts.push({time: data[i].time, value:Math.round(data[i].response_start)});
        this.page.speedIndexes.push({time: data[i].time, value:Math.round(data[i].speedIndex)});
      }

      this.notifyPath('page.domReadies', this.page.domReadies);
      this.notifyPath('page.firstPaints', this.page.firstPaints);
      this.notifyPath('page.pageLoads', this.page.pageLoads);
      this.notifyPath('page.responseStarts', this.page.responseStarts);
      this.notifyPath('page.speedIndexes', this.page.speedIndexes);
    }

    handleGenericError: function(error) {
      this.fire('message', {message: error.errors[0]});
    },

    handleMessage: function(e) {
      this.showToast(e.detail.message);
    },

    handleShowPages: function(e) {
      page('/');
    },

    handleShowPage: function(e) {
      var path = '/page/' + e.detail.page.id;
      page(path);
    },

    handleEditPage: function(e) {
      var path = '/edit-page/' + e.detail.page.id;
      page(path);
    },

    handlePageCreated: function(e) {
      this.loadPages();
      page('/');
    },

    handlePageDeleted: function(e) {
      this.loadPages();
      page('/');
    },

    handleSignedIn: function(e) {
      this.user = e.detail.user;
      page('/');
    },

    handleSignedOut: function(e) {
      TwbService.signout();
      page('/signin');
    },

    showToast: function(message) {
      var toast = this.$['message-toast'];
      toast.text = message;
      toast.show();
    },
 });

})();
</script>
