<script src="../bower_components/page/page.js"></script>
<script>
  window.addEventListener('WebComponentsReady', function() {

    /**
     * Middleware for authentication check
     */
    function authenticate(ctx, next) {
      qstr = _parseQuery(ctx.querystring);

      // Check if we find credentials in parameters (used for omniauth)
      // if true : store credentials and remove them from the query string
      if (qstr.auth_token) {
        BnbService.storeCredentials(qstr.auth_token, qstr.uid, qstr.client_id);
        _removeParameters();
      }

      // Check if we find a message in the query string.
      // If true : display it to the user
      if (qstr.message) {
        app.showToast(qstr.message);
      }

      if (ctx.pathname==='/signin' || ctx.pathname==='/signup' || ctx.pathname==='/forgot' || ctx.pathname==='/edit-password') {
        next();
      }
      else if (app.isLogged()) {
        next();
      }
      else {
        page.redirect('/signin');
      }
    }

    function analytics(ctx, next) {
      ga('send', 'pageview', ctx.pathname);
      next();
    }

    function loadPages(ctx, next) {
      app.loadPages();
      next();
    }

    function loadPage(ctx, next) {
      var id = ctx.params.id;
      app.loadPage(id);
      next();
    }

    function loadUser(ctx, next) {
      app.loadUser();
      next();
    }

    function loadMembers(ctx, next) {
      var id = ctx.params.id;
      app.loadMembers(id);
      next();
    }

    // Interceptor for all pages
    page('*', authenticate, analytics, function(ctx, next) {
      next();
    });

    page('/signin', function() {
      app.route = 'signin';
    });

    page('/signup', function() {
      app.route = 'signup';
    });

    page('/forgot', function() {
      app.route = 'forgot';
    });

    page('/edit-password', function() {
      app.route = 'edit-password';
    });

    page('/', loadPages, function() {
      app.route = 'home';
    });

    page('/preferences', loadUser, function() {
      app.route = 'preferences';
    });

    page('/page/:id', loadPage, function() {
      app.route = 'page';
    });

    page('/edit-page/:id', loadPage, function() {
      app.route = 'edit-page';
    });

    page('/edit-members/:id', loadMembers, function() {
      app.route = 'edit-members';
    });

    page('/add-page', function() {
      app.route = 'add-page';
    });

    // 404
    page('*', function() {
      app.showToast('Can\'t find: ' + window.location.href  + '. Redirected you to Home Page');
      page.redirect(app.baseUrl);
    });

    page({
      hashbang: true
    });

    function _parseQuery(qstr) {
      var query = {};
      if (qstr.indexOf('#') >= 0) {
        qstr = qstr.slice(0, qstr.indexOf('#'));
      }
      if (qstr.indexOf('?') >= 0) {
        qstr = qstr.slice(0, qstr.indexOf('?'));
      }
      var a = qstr.split('&');
      for (var i = 0; i < a.length; i++) {
          var b = a[i].split('=');
          query[decodeURIComponent(b[0])] = decodeURIComponent(b[1] || '');
      }
      return query;
    }

    /**
     * Remove all query string from the url (and hash too)
     */
    function _removeParameters() {
      var newLocation = window.location.protocol + '//'+
              window.location.host+
              window.location.pathname;
      window.history.pushState('', document.title, newLocation);
    }
  });
</script>
