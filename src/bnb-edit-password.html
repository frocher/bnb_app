<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="bnb-auth-form.html">
<link rel="import" href="bnb-data.html">

<dom-module id="bnb-edit-password">
  <template>
    <iron-a11y-keys keys="enter" target="[[target]]" on-keys-pressed="submitTapped">
    </iron-a11y-keys>
    <bnb-data id="data"></bnb-data>

    <bnb-auth-form id="edit-form" title="Edit your new password" buttons="[[editButtons]]">

      <paper-input id="password" label="Password" type="password" value="{{password}}" autofocus="true">
      </paper-input>

      <paper-input id="password_confirmation" label="Password confirmation" autocomplete="off" type="password" value="{{passwordConfirmation}}">
      </paper-input>

      <div class="actions">
        <iron-pages id="actionButtons" selected="0">
          <paper-button title="Change your password" on-tap="submitTapped">Change</paper-button>
        </iron-pages>
      </div>
    </bnb-auth-form>
  </template>

  <script>
    class BnbEditPassword extends Polymer.Element {
      static get is() { return 'bnb-edit-password'; }

      static get properties() {
        return {
          target: Object,
          editButtons: Array,
          password: {
            type: String,
            value: ''
          },
          passwordConfirmation: {
            type: String,
            value: ''
          }
        }
      }

      ready() {
        super.ready();
        this.target = this.$['edit-form'];
        this.editButtons = [{text:'Sign in', path:'/signin'}];
        this.addEventListener('update_password_success', e => {this.handleSuccess(e.detail)})
        this.addEventListener('update_password_error', e => {this.handleError(e.detail)})
      }

      submitTapped() {
        this.$['password'].invalid = false;
        this.$['password_confirmation'].invalid = false;

        let headers = {
          'access-token': this._getQueryVariable('token'),
          'client': this._getQueryVariable('client_id'),
          'uid': this._getQueryVariable('uid')
        };

        this.$.data.updatePassword(this.password, this.passwordConfirmation, headers);
      }

      handleSuccess(response) {
        window.history.pushState({}, null, '/signin');
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      handleError(errors) {
        if (errors[0] !== undefined) {
          this.dispatchEvent(new CustomEvent('message', {bubbles: true, composed: true, detail: errors[0]}));
        }
        else {
          for (var prop in errors) {
            if (errors.hasOwnProperty(prop)) {
              var objId = '' + prop;
              if (this.$[objId] !== undefined) {
                this.$[objId].invalid = true;
                this.$[objId].errorMessage = errors[prop][0];
              }
            }
          }
        }
      }

      _getQueryVariable(variable) {
        let hrefPart = window.location.href;
        let query = hrefPart.substring(hrefPart.indexOf('?') + 1);
        let vars = query.split('&');
        for (let i = vars.length - 1;i >= 0 ; i--) {
          let pair = vars[i].split('=');
          if(pair[0] === variable) {
            return decodeURIComponent(pair[1]);
          }
        }
        return undefined;
      }

    }

    window.customElements.define(BnbEditPassword.is, BnbEditPassword);

  </script>

</dom-module>
