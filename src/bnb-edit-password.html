<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="bnb-actions.html">
<link rel="import" href="bnb-auth-form.html">

<dom-module id="bnb-edit-password">
  <template>
    <iron-a11y-keys keys="enter" target="[[target]]" on-keys-pressed="submitTapped">
    </iron-a11y-keys>

    <bnb-auth-form id="edit-form" title="Edit your new password" buttons="[[editButtons]]">

      <paper-input id="password" label="Password" type="password" value="{{password}}" autofocus="true">
      </paper-input>

      <paper-input id="password_confirmation" label="Password confirmation" autocomplete="off" type="password" value="{{passwordConfirmation}}">
      </paper-input>

      <div class="actions">
        <iron-pages id="actionButtons" selected="0">
          <paper-button title="Change your password" on-tap="submitTapped">Change</paper-button>
        </iron-pages>
      </div>
    </bnb-auth-form>
  </template>

  <script>
    class BnbEditPassword extends BnbActions(Polymer.Element) {
      static get is() { return 'bnb-edit-password'; }

      static get properties() {
        return {
          target: Object,
          editButtons: Array,
          password: {
            type: String,
            value: ''
          },
          passwordConfirmation: {
            type: String,
            value: ''
          },
          errors: {
            type: Object,
            statePath: 'errors',
            observer: '_errorsChanged'
          }
        }
      }

      ready() {
        super.ready();
        this.target = this.$['edit-form'];
        this.editButtons = [{text:'Sign in', path:'/signin'}];
      }

      submitTapped() {
        this.$['password'].invalid = false;
        this.$['password_confirmation'].invalid = false;

        let headers = {
          'access-token': this._getQueryVariable('token'),
          'client': this._getQueryVariable('client_id'),
          'uid': this._getQueryVariable('uid')
        };

        this.updatePassword(this.password, this.passwordConfirmation, headers);
      }

      _getQueryVariable(variable) {
        let hrefPart = window.location.href;
        let query = hrefPart.substring(hrefPart.indexOf('?') + 1);
        let vars = query.split('&');
        for (let i = vars.length - 1;i >= 0 ; i--) {
          let pair = vars[i].split('=');
          if(pair[0] === variable) {
            return decodeURIComponent(pair[1]);
          }
        }
        return undefined;
      }

    }

    window.customElements.define(BnbEditPassword.is, BnbEditPassword);

  </script>

</dom-module>
