<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">

<dom-module id="bnb-data">
  <template>
    <app-localstorage-document key="bnb-data" data="{{user}}"></app-localstorage-document>
  </template>

  <script>
    class BnbData extends Polymer.Element {
      static get is() { return 'bnb-data'; }

      static get baseUrl() { return 'http://localhost:3000/'; }

      static get properties() {
        return {
          analyticsKey: String,

          user: {
            type: Object,
            value: () => undefined,
            notify: true
          },

          pages: {
            type: Array,
            notify: true
          },

          page: {
            type: Object,
            notify: true
          },

          period: Object,

          offline: Boolean,

          loading: {
            type: Boolean,
            readOnly: true,
            notify: true
          },

          failure: {
            type: Boolean,
            readOnly: true,
            notify: true
          }
        }
      }

      isLogged() {
        return sessionStorage.getItem('credentials') !== null;
      }

      loadEnvironment() {
        this._getResource({
          url: this._getRequestUrl('/environment', {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.analyticsKey = response.GOOGLE_ANALYTICS_KEY;
              this.dispatchEvent(new CustomEvent('load_environment_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this._fireError(response.errors);
              this.dispatchEvent(new CustomEvent('load_environment_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      signin(email, password) {
        let url = this._getRequestUrl('/auth/sign_in', {email: email, password: password});

        this._getResource({
          url: url,
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._storeCredentials(e.target);
              this.user = response.data;
              this.dispatchEvent(new CustomEvent('signedin', {bubbles: true, composed: true, detail: response.data}));
            }
            else {
              this._fireError(response.errors);
            }
          }
        });
      }

      signout() {
        sessionStorage.removeItem('credentials');
        this.dispatchEvent(new CustomEvent('signedout', {bubbles: true, composed: true}));
      }

      signup(name, email, password, confirmation, successUrl) {
        let url = this._getRequestUrl('/auth/', {
          name: name,
          email: email,
          password: password,
          password_confirmation: confirmation,
          confirm_success_url: successUrl
        });

        this._getResource({
          url: url,
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._fireMessage('Sign up successful. An activation email has been sent to you.');
            }
            else {
              if (response.errors) {
                this.dispatchEvent(new CustomEvent('signup_error', {bubbles: true, composed: true, detail: response.errors}));
              }
              else {
                this._fireMessage('Unknown error. Can\'t signup.');
              }
            }
          }
        });
      }

      forgotPassword(email, redirectUrl) {
        let url = this._getRequestUrl('/auth/password', {
          email: email,
          redirect_url: redirectUrl
        });

        this._getResource({
          url: url,
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._fireMessage(response.message);
            }
            else {
              this._fireError(response.errors);
            }
          }
        });
      }

      updatePassword(password, passwordConfirmation, headers) {
        let url = this._getRequestUrl('/auth/password', {
          password: password,
          password_confirmation: passwordConfirmation
        });

        this._getResource({
          url: url,
          method: 'PUT',
          headers: headers,
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._fireMessage(response.message);
              this.dispatchEvent(new CustomEvent('update_password_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.dispatchEvent(new CustomEvent('update_password_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      loadPages() {
        this._getResource({
          url: this._getRequestUrl('/pages', {per_page:9999}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.pages = response;
              this.dispatchEvent(new CustomEvent('load_pages_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this._fireError(response.errors);
              this.dispatchEvent(new CustomEvent('load_pages_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      loadPage(id, opts) {
        this._getResource({
          url: this._getRequestUrl('/pages/' + id, {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.page = response;
              if (opts.withMeasures) {
                this.loadPageMeasures(this.page);
              }
              if (opts.withMembers) {
                this.loadPageMembers(this.page);
              }
              this.dispatchEvent(new CustomEvent('load_page_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this._fireError(response.errors);
              this.dispatchEvent(new CustomEvent('load_page_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      loadPageMembers(page) {
        this._getResource({
          url: this._getRequestUrl('/pages/' + page.id + '/members', {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              page.members = response;
              this.notifyPath('page.members', this.page.members);
              this.dispatchEvent(new CustomEvent('load_page_members_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this._fireError(response.errors);
              this.dispatchEvent(new CustomEvent('load_page_members_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      loadPageMeasures(page) {
        let start = this.period.start;
        let end   = this.period.end;

        this._getResource({
          url: this._getRequestUrl('/pages/' + page.id + '/stats', {start: start, end: end}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._updateUptime(response.uptime[0]);
              this._updateCount(response.performance.desktop);
              this._updateCount(response.performance.mobile);
              this._updateBytes(response.bytes.desktop);
              this._updateBytes(response.bytes.mobile);
              this._updateCount(response.requests.desktop);
              this._updateCount(response.requests.mobile);

              this.page.stats = response;
              this.notifyPath('page.stats', this.page.stats);
              this.dispatchEvent(new CustomEvent('load_page_measures_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this._fireError(response.errors);
              this.dispatchEvent(new CustomEvent('load_page_measures_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      createPage(name, url) {
        this._getResource({
          url: this._getRequestUrl('/pages', { name: name, url: url }),
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._fireMessage('Page created');
              this.dispatchEvent(new CustomEvent('create_page_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.dispatchEvent(new CustomEvent('create_page_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      updatePage(id, page) {
        this._getResource({
          url: this._getRequestUrl('/pages/' + id, page),
          method: 'PUT',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.set('page', response);
              this._fireMessage('Page has been updated');
              this.dispatchEvent(new CustomEvent('update_page_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.dispatchEvent(new CustomEvent('update_page_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      createPageMember(page, member) {
        this._getResource({
          url: this._getRequestUrl('/pages/' + page.id + '/members', member),
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadPageMembers(page);
              this.dispatchEvent(new CustomEvent('create_page_member_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.dispatchEvent(new CustomEvent('create_page_member_error', {bubbles: true, composed: true, detail: response}));
            }
          }
        });
      }

      updatePageMember(page, member) {
        this._getResource({
          url: this._getRequestUrl('/pages/' + page.id + '/members/'  + member.id, member),
          method: 'PUT',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadPageMembers(page);
              this.dispatchEvent(new CustomEvent('update_page_member_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.dispatchEvent(new CustomEvent('update_page_member_error', {bubbles: true, composed: true, detail: response}));
            }
          }
        });
      }

      deletePageMember(page, memberId) {
        this._getResource({
          url: this._getRequestUrl('/pages/' + page.id + '/members/' + memberId, {}),
          method: 'DELETE',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadPageMembers(page);
              this.dispatchEvent(new CustomEvent('delete_page_member_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.dispatchEvent(new CustomEvent('delete_page_member_error', {bubbles: true, composed: true, detail: response}));
            }
          }
        });
      }

      loadUser() {
        this._getResource({
          url: this._getRequestUrl('/users/-1', {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.user = response;
              this.dispatchEvent(new CustomEvent('load_user_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.fireError(response.errors);
              this.dispatchEvent(new CustomEvent('load_user_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      updateUser(id, user) {
        this._getResource({
          url: this._getRequestUrl('/users/' + id, user),
          method: 'PUT',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._fireMessage('User preferences have been updated');
              this.dispatchEvent(new CustomEvent('update_user_success', {bubbles: true, composed: true, detail: response}));
            }
            else {
              this.dispatchEvent(new CustomEvent('update_user_error', {bubbles: true, composed: true, detail: response.errors}));
            }
          }
        });
      }

      _updateUptime(data) {
        data.summary = Math.round(data.summary * 10000) / 100;
        for (let i = 0; i < data.values.length; i++) {
          data.values[i].value = Math.round(data.values[i].value * 10000) / 100;
        }
      }

      _updateCount(data) {
        for (let iSeries = 0; iSeries < data.length; iSeries++) {
          let serie = data[iSeries];
          serie.summary = Math.round(serie.summary);
          for (let iValue = 0; iValue < serie.values.length; iValue++) {
            serie.values[iValue].value = Math.round(serie.values[iValue].value);
          }
        }
      }

      _updateBytes(data) {
        for (let iSeries = 0; iSeries < data.length; iSeries++) {
          let serie = data[iSeries];
          serie.summary = Math.round(serie.summary*10/1024)/10;
          for (let iValue = 0; iValue < serie.values.length; iValue++) {
            serie.values[iValue].value = Math.round(serie.values[iValue].value*10/1024)/10;
          }
        }
      }

      _fireError(errors) {
        let message = errors !== undefined ? errors[0] : 'Oops something went wrong.';
        this._fireMessage(message);
      }

      _fireMessage(message) {
        this.dispatchEvent(new CustomEvent('message', {bubbles: true, composed: true, detail: message}));
      }

      _storeCredentials(xhr) {
        let credentials = {
          'access-token': xhr.getResponseHeader('access-token'),
          uid: xhr.getResponseHeader('uid'),
          client: xhr.getResponseHeader('client'),
          'token-type': 'Bearer'
        };
        sessionStorage.setItem('credentials', JSON.stringify(credentials));
      }

      _fetchCredentials() {
        let credentials = sessionStorage.getItem('credentials');
        if (credentials) {
          return JSON.parse(credentials);
        }
        return null;
      }

      _deleteCredentials() {
        return sessionStorage.removeItem('credentials');
      }

      _getResource(rq, attempts) {
        this._setFailure(false);
        let xhr = new XMLHttpRequest();

        xhr.addEventListener('load', (e) => {
          rq.onLoad.call(this, e);
        });

        xhr.addEventListener('error', (e) => {
          this._setFailure(true);
          if (rq.onError) {
            rq.onError.call(this, e);
          }
          else {
            this._fireMessage('Network failure. Try again.');
          }
        });

        xhr.open(rq.method, rq.url);

        let headers = this._fetchCredentials() || {};
        if (rq.headers) {
          headers = Object.assign(headers, rq.headers)
        }
        for (let header in headers) {
          if (headers[header]) {
            xhr.setRequestHeader(header, headers[header].toString());
          }
        }

        xhr.send();
      }

      _getRequestUrl(url, params) {
        let queryString = this._getQueryString(params);
        if (queryString) {
          return BnbData.baseUrl + url + '?' + queryString;
        }
        return BnbData.baseUrl + url;
      }

      _getQueryString(params) {
        let queryParts = [];

        for (let param in params) {
          let value = params[param];
          param = window.encodeURIComponent(param);

          if (value !== null) {
            param += '=' + window.encodeURIComponent(value);
          }

          queryParts.push(param);
        }

        return queryParts.join('&');
      }
    }
    customElements.define(BnbData.is, BnbData);

  </script>

</dom-module>
