<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bnb-actions.html">
<link rel="import" href="bnb-analytics.html">
<link rel="import" href="bnb-common-styles.html">
<link rel="import" href="bnb-home.html">
<link rel="import" href="bnb-signin.html">

<dom-module id="bnb-app">
  <template>
    <style>
      :host {
        --dark-primary-color: #000000;
        --default-primary-color:var(--paper-grey-900);
        --light-primary-color: #303030;
        --text-primary-color: #ffffff; /*text/icons*/
        --accent-color: #FF5722;
        --primary-background-color: #303030;
        --primary-text-color: #ffffff;
        --secondary-text-color: var(--paper-grey-300);
        --disabled-text-color: #bdbdbd;
        --divider-color: #B6B6B6;
        --error-color: #db4437;

        --paper-card-background-color: var(--paper-grey-800);
        --paper-card-header-color: var(--text-primary-color);
        --paper-dialog-button-color: var(--google-blue-300);
        --paper-divider-color: #B6B6B6;
        --paper-input-container-color: var(--secondary-text-color);
        --paper-input-container-focus-color: var(--google-blue-300);
        --paper-radio-button-checked-color: var(--google-blue-300);
        --paper-tabs-selection-bar-color: var(--google-blue-300);
        --paper-toggle-button-checked-button-color: var(--google-blue-300);
        --paper-toggle-button-checked-ink-color: var(--google-blue-500);


        background-color: var(--primary-background-color);
        @apply --layout-fit;
        @apply --layout-vertical;
      }

      .view {
        @apply --layout-fit;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <bnb-analytics id="analytics" key="[[analyticsKey]]"></bnb-analytics>

    <iron-pages class="view" selected="[[view]]" attr-for-selected="name" selected-attribute="visible" fallback-selection="404">
      <bnb-add-page         name="add-page"         class="view"></bnb-add-page>
      <bnb-home             name="home"             class="view" period="{{period}}"></bnb-home>
      <bnb-members          name="members"          class="view"></bnb-members>
      <bnb-edit-page        name="edit-page"        class="view"></bnb-edit-page>
      <bnb-edit-password    name="edit-password"    class="view"></bnb-edit-password>
      <bnb-forgot-password  name="forgot-password"  class="view"></bnb-forgot-password>
      <bnb-page             name="page"             class="view" period="{{period}}"></bnb-page>
      <bnb-signin           name="signin"           class="view"></bnb-signin>
      <bnb-signup           name="signup"           class="view"></bnb-signup>
      <bnb-user-preferences name="user-preferences" class="view"></bnb-user-preferences>
      <bnb-404-warning      name="404"              class="view"></bnb-404-warning>
    </iron-pages>

    <paper-toast id="message-toast" duration="4000"></paper-toast>
  </template>

  <script src="../bower_components/moment/min/moment.min.js"></script>

  <script>
    class BnbApp extends BnbActions(Polymer.Element) {
      static get is() { return 'bnb-app'; }

      static get properties() {
        return {
          routePath: {
            type: String,
            reflectToAttribute: true,
            statePath: 'route',
            observer: '_routePathChanged'
          },

          view: {
            type: String,
            reflectToAttribute: true,
            observer: '_viewChanged'
          },

          message: {
            type: Object,
            statePath: 'message',
            observer: '_messageChanged'
          },

          analyticsKey: {
            type: String,
            statePath: 'analyticsKey'
          },

          page: {
            type: Object,
            statePath: 'page'
          },

          page_stats: {
            type: Object,
            statePath: 'page_stats'
          },

          period: {
            type: Object,
            value: {start: moment().subtract(30, 'days').toDate(), end: moment().toDate()},
            notify: true
          },

          offline: {
            type: Boolean,
            value: false,
            readOnly: true
          }
        };
      }

      static get observers() { return [
        '_routeViewChanged(routeData.page)'
      ]}

      ready() {
        super.ready();
        this.removeAttribute('unresolved');
        this.loadEnvironment();
        this.addEventListener('period-changed', e => {this._handlePeriodChanged()});
      }

      _routePathChanged(path, oldPath) {
        window.history.pushState({}, null, '/' + path);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      _routeViewChanged(view) {
        if (view !== 'signin' && view !== 'signup' && view !== 'forgot-password' && view !== 'edit-password') {
          if (!this.isLogged()) {
            this.dispatch('updateRoute', 'signin');
          }
        }
        this.view = view || 'home';
      }

      _viewChanged(view, oldView) {
        if (view !== null) {
          // home and signin route are eagerly loaded
          if (view === 'home' || view === 'signin') {
            this._viewLoaded(Boolean(oldView));
          // other routes are lazy loaded
          } else {
            // When a load failed, it triggered a 404 which means we need to
            // eagerly load the 404 page definition
            let cb = this._viewLoaded.bind(this, Boolean(oldView));
            Polymer.importHref(
              this.resolveUrl('bnb-' + view + '.html'),
              cb, cb, true);
          }
        }
      }

      _viewLoaded(shouldResetLayout) {
       this._ensureLazyLoaded();
       this.$.analytics.sendPath(this.route);

       if (this.view === 'home') {
         this.loadPages();
       }
       else if (this.view === 'user-preferences') {
         this.loadUser();
       }
       else if (this.view === 'page' || this.view === 'edit-page' || this.view === 'members') {
         let pageId = Number(this.subroute.path.substring(1));
         if (!this.page || this.page.id !== pageId) {
           this.loadPage(pageId);
           this.loadPageStats(pageId);
           this.loadPageMembers(pageId);
         }
       }
     }

     _ensureLazyLoaded() {
       // load lazy resources after render and set `loadComplete` when done.
       if (!this.loadComplete) {
         Polymer.RenderStatus.afterNextRender(this, () => {
           Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
             this._notifyNetworkStatus();
             this.loadComplete = true;
             // Load pre-caching Service Worker
             if ('serviceWorker' in navigator) {
               navigator.serviceWorker.register('service-worker.js');
             }
           });
         });
       }
     }

     _notifyNetworkStatus() {
        let oldOffline = this.offline;
        this._setOffline(!window.navigator.onLine);
        // Show the snackbar if the user is offline when starting a new session
        // or if the network status changed.
        if (this.offline || (!this.offline && oldOffline === true)) {
          if (!this._networkSnackbar) {
            this._networkSnackbar = document.createElement('bnb-snackbar');
            this.root.appendChild(this._networkSnackbar);
          }
          this._networkSnackbar.textContent = this.offline ?
              'You are offline' : 'You are online';
          this._networkSnackbar.open();
        }
      }

      _messageChanged(newVal, oldVal) {
        if (newVal && newVal.text) {
          let toast = this.$['message-toast'];
          toast.show(newVal.text);
        }
      }

      _handlePeriodChanged() {
        if (this.view === 'page') {
          this.loadPageStats(this.page.id);
        }
      }
    }

    window.customElements.define(BnbApp.is, BnbApp);
  </script>
</dom-module>
