<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bnb-actions.html">
<link rel="import" href="bnb-analytics.html">
<link rel="import" href="bnb-common-styles.html">
<link rel="import" href="bnb-home.html">
<link rel="import" href="bnb-signin.html">

<dom-module id="bnb-app">
  <template>
    <style>
      :host {
        --dark-primary-color: #000000;
        --default-primary-color:var(--paper-grey-900);
        --light-primary-color: #303030;
        --text-primary-color: #ffffff; /*text/icons*/
        --accent-color: #FF5722;
        --primary-background-color: #303030;
        --primary-text-color: #ffffff;
        --secondary-text-color: var(--paper-grey-300);
        --disabled-text-color: #bdbdbd;
        --divider-color: #B6B6B6;
        --error-color: #db4437;

        --paper-card-background-color: var(--paper-grey-800);
        --paper-card-header-color: var(--text-primary-color);
        --paper-dialog-button-color: var(--google-blue-300);
        --paper-divider-color: #B6B6B6;
        --paper-input-container-color: var(--secondary-text-color);
        --paper-input-container-focus-color: var(--google-blue-300);
        --paper-radio-button-checked-color: var(--google-blue-300);
        --paper-tabs-selection-bar-color: var(--google-blue-300);
        --paper-toggle-button-checked-button-color: var(--google-blue-300);
        --paper-toggle-button-checked-ink-color: var(--google-blue-500);


        background-color: var(--primary-background-color);
        @apply --layout-fit;
        @apply --layout-vertical;
      }

      .view {
        @apply --layout-fit;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>

    <bnb-analytics id="analytics" key="[[analyticsKey]]"></bnb-analytics>

    <iron-pages class="view" selected="[[view]]" attr-for-selected="name" selected-attribute="visible" fallback-selection="404">
      <bnb-add-page            name="add-page"            class="view"></bnb-add-page>
      <bnb-bytes-details       name="bytes-details"       class="view"></bnb-bytes-details>
      <bnb-home                name="home"                class="view"></bnb-home>
      <bnb-members             name="members"             class="view"></bnb-members>
      <bnb-edit-page           name="edit-page"           class="view"></bnb-edit-page>
      <bnb-edit-password       name="edit-password"       class="view"></bnb-edit-password>
      <bnb-forgot-password     name="forgot-password"     class="view"></bnb-forgot-password>
      <bnb-lighthouse-details  name="lighthouse-details"  class="view"></bnb-lighthouse-details>
      <bnb-page                name="page"                class="view"></bnb-page>
      <bnb-performance-details name="performance-details" class="view"></bnb-performance-details>
      <bnb-requests-details    name="requests-details"    class="view"></bnb-requests-details>
      <bnb-signin              name="signin"              class="view"></bnb-signin>
      <bnb-signup              name="signup"              class="view"></bnb-signup>
      <bnb-uptime-details      name="uptime-details"      class="view"></bnb-uptime-details>
      <bnb-user-preferences    name="user-preferences"    class="view"></bnb-user-preferences>
      <bnb-404-warning         name="404"                 class="view"></bnb-404-warning>
    </iron-pages>

    <paper-toast id="message-toast" duration="4000"></paper-toast>
  </template>

  <script>
    class BnbApp extends BnbActions(Polymer.Element) {
      static get is() { return 'bnb-app'; }

      static get properties() {
        return {
          routePath: {
            type: String,
            reflectToAttribute: true,
            statePath: 'route',
            observer: '_routePathChanged'
          },

          view: {
            type: String,
            reflectToAttribute: true,
            observer: '_viewChanged'
          },

          message: {
            type: Object,
            statePath: 'message',
            observer: '_messageChanged'
          },

          analyticsKey: {
            type: String,
            statePath: 'analyticsKey'
          },

          page: {
            type: Object,
            statePath: 'page'
          },

          page_stats: {
            type: Object,
            statePath: 'page_stats'
          },

          period: {
            type: Object,
            statePath: 'period',
            observer: '_periodChanged'
          },

          offline: {
            type: Boolean,
            value: false,
            readOnly: true
          }
        };
      }

      static get observers() { return [
        '_routeViewChanged(routeData.page)'
      ]}

      ready() {
        super.ready();
        this.removeAttribute('unresolved');
        this.loadEnvironment();
      }

      _routePathChanged(path, oldPath) {
        window.history.pushState({}, null, '/' + path);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      _routeViewChanged(view) {
        // Check if we find credentials in parameters (used for omniauth)
        // if true : store credentials and remove them from the query string
        if (this._getUrlParameter('auth_token')) {
          this.storeCredentials(this._getUrlParameter('auth_token'), this._getUrlParameter('uid'), this._getUrlParameter('client_id'));
          this._removeParameters();
        }

        if (view !== 'signin' && view !== 'signup' && view !== 'forgot-password' && view !== 'edit-password') {
          if (!this.isLogged()) {
            this.dispatch('updateRoute', 'signin');
          }
        }
        this.view = view || 'home';
      }

      _viewChanged(view, oldView) {
        if (view !== null) {
          // home and signin route are eagerly loaded
          if (view === 'home' || view === 'signin') {
            this._viewLoaded(Boolean(oldView));
          // other routes are lazy loaded
          } else {
            // When a load failed, it triggered a 404 which means we need to
            // eagerly load the 404 page definition
            let cb = this._viewLoaded.bind(this, Boolean(oldView));
            Polymer.importHref(
              this.resolveUrl('bnb-' + view + '.html'),
              cb, cb, true);
          }
        }
      }

      _viewLoaded(shouldResetLayout) {
       this._ensureLazyLoaded();
       this.$.analytics.sendPath(this.route);

       if (this.isLogged()) {
         if (this.view === 'home') {
           this.loadPages();
         }
         else if (this.view === 'user-preferences') {
           this.loadUser();
         }
         // FIXME : implement a better way to load data. Perhaps, this should be treated by reducers
         else if (this.view === 'page' || this.view === 'edit-page' || this.view === 'members' ||
                  this.view === 'lighthouse-details' || this.view === 'performance-details'
                  || this.view === 'uptime-details'
                  || this.view === 'requests-details' || this.view === 'bytes-details') {
           let pageId = Number(this.subroute.path.substring(1));
           if (!this.page || this.page.id !== pageId) {
             this.loadPage(pageId);
             this.loadPageStats(pageId);
             this.loadPageMembers(pageId);
             this.loadLighthouseDetails(pageId);
             this.loadUptimeDetails(pageId);
             this.loadAssetsDetails(pageId);
           }
         }
       }
     }

     _ensureLazyLoaded() {
       // load lazy resources after render and set `loadComplete` when done.
       if (!this.loadComplete) {
         Polymer.RenderStatus.afterNextRender(this, () => {
           Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
             this._notifyNetworkStatus();
             this.loadComplete = true;
             // Load pre-caching Service Worker
             if ('serviceWorker' in navigator) {
               navigator.serviceWorker.register('service-worker.js', {scope: '/'});
             }
           });
         });
       }
     }

     _notifyNetworkStatus() {
        let oldOffline = this.offline;
        this._setOffline(!window.navigator.onLine);
        // Show the snackbar if the user is offline when starting a new session
        // or if the network status changed.
        if (this.offline || (!this.offline && oldOffline === true)) {
          if (!this._networkSnackbar) {
            this._networkSnackbar = document.createElement('bnb-snackbar');
            this.root.appendChild(this._networkSnackbar);
          }
          this._networkSnackbar.textContent = this.offline ?
              'You are offline' : 'You are online';
          this._networkSnackbar.open();
        }
      }

      _messageChanged(newVal, oldVal) {
        if (newVal && newVal.text) {
          let toast = this.$['message-toast'];
          toast.show(newVal.text);
        }
      }

      _periodChanged(newVal, oldVal) {
        if (this.view === 'page' && this.page) {
          this.loadPageStats(this.page.id);
        }
      }

      _getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      /**
       * Remove all query string from the url (and hash too)
       */
      _removeParameters() {
        var newLocation = window.location.protocol + '//'+
                window.location.host+
                window.location.pathname;
        window.history.pushState('', document.title, newLocation);
      }
    }

    window.customElements.define(BnbApp.is, BnbApp);
  </script>
</dom-module>
