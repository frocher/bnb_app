<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bnb-chart.html">
<link rel="import" href="bnb-value-chip.html">

<dom-module id="bnb-chart-card">
  <template>
    <style>
      :host {
        display: flex;
        margin: 16px;
      }

      paper-card {
        width: 100%;
      }

      #chips {
        text-align: center;

        align-items: stretch;
        @apply --layout-horizontal;
        @apply --layout-wrap;
      }

      bnb-value-chip {
        flex: 1;
      }

      #chart {
        width: 100%;
        height: 340px;
      }
    </style>

    <paper-card heading="[[name]]">
      <div class="card-content">
        <div id="chips">
          <template is="dom-repeat" id="values" items="[[getData(data)]]">
            <bnb-value-chip text="[[computeLabel(item)]]" value="[[item.summary]]" suffix="[[computeSuffix(item)]]">
            </bnb-value-chip>
          </template>
        </div>
        <bnb-chart id="chart" stacked="[[stacked]]" data="[[getData(data)]]" model="[[model]]"></bnb-chart>
      </div>
      <div class="card-actions" hidden$="[[hasNoDomain(data)]]">
        <paper-tabs selected="0" style="width:100px">
          <paper-tab on-tap="desktopTapped">
            <iron-icon icon="hardware:computer"></iron-icon>
          </paper-tab>
          <paper-tab on-tap="mobileTapped">
            <iron-icon icon="hardware:smartphone"></iron-icon>
          </paper-tab>
        </paper-tabs>
      </div>
    </paper-card>
  </template>

  <script>

    class BnbChartCard extends Polymer.Element {
      static get is() { return 'bnb-chart-card'; }

      static get properties() {
        return {
          name: {
            type: String,
            value: ''
          },
          data: {
            type: Object,
            value: function () {
              return {};
            }
          },
          model: {
            type: Array,
            value: function () {
              return [];
            }
          },
          stacked: {
            type: Boolean,
            value: false
          },
          target: {
            type: String,
            value: 'desktop'
          }
        }
      }

      ready() {
        super.ready();
        this._polyfillFind();
      }

      hasNoDomain(data) {
        if (this.data) {
          return this.data instanceof Array;
        }
        return true;
      }

      getData() {
        if (this.data) {
          if (this.data instanceof Array) {
            return this.data;
          }
          else {
            return this.data[this.target];
          }
        }
        return undefined;
      }

      computeLabel(o) {
        let item = this.model.find(function(i) { return i.name === o.key; });
        if (item) {
          return item.label;
        }
        return "";
      }

      computeSuffix(o) {
        let item = this.model.find(function(i) { return i.name === o.key; });
        if (item) {
          return item.suffix;
        }
        return "";
      }

      desktopTapped() {
        this.switchToTarget("desktop");
      }

      mobileTapped() {
        this.switchToTarget("mobile");
      }

      switchToTarget(newTarget) {
        if (this.target !== newTarget) {
          this.target = newTarget;
          this.$.values.items = this.data[this.target];
          this.$.chart.data = this.data[this.target];
        }
      }

      _polyfillFind() {
        if (!Array.prototype.find) {
          Object.defineProperty(Array.prototype, 'find', {
            value: function(predicate) {
              if (this == null) {
                throw new TypeError('"this" is null or not defined');
              }

              var o = Object(this);
              var len = o.length >>> 0;

              if (typeof predicate !== 'function') {
                throw new TypeError('predicate must be a function');
              }

              var thisArg = arguments[1];
              var k = 0;

              while (k < len) {
                var kValue = o[k];
                if (predicate.call(thisArg, kValue, k, o)) {
                  return kValue;
                }
                k++;
              }
              return undefined;
            }
          });
        }
      }
    }
    customElements.define(BnbChartCard.is, BnbChartCard);

  </script>

</dom-module>
