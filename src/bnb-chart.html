<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="bnb-chart">
  <template>
    <style>
      :host {
        display: inline-block;
      }

      iron-pages {
        width: 100%;
        height: 100%;
      }

      #canvas {
        position:relative;
        width: 100%;
        height: 100%;
      }

      #loading {
        display: flex;

        width: 100%;
        height: 100%;

        color: #999;

        font-size: 24px;

        align-items: center;
        justify-content: center;
      }

      #noData {
        display: flex;
        width: 100%;
        height: 100%;
        color: #999;
        font-size: 36px;
        align-items: center;
        justify-content: center;
      }

      #noData span {
        margin-top: -50px;
      }
    </style>

    <iron-pages selected="[[selectedPage]]">
      <div id="loading">
        <span>Loading&nbsp;</span>
        <paper-spinner active></paper-spinner>
      </div>
      <div id="noData"><span>No data</span></div>
      <div id="canvas">
        <canvas id="chart"></canvas>
      </div>
    </iron-pages>
  </template>

  <script src="../bower_components/chart.js/dist/Chart.js"></script>
  <script src="../bower_components/lodash/dist/lodash.min.js"></script>

  <script>
    class BnbChart extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
      static get is() { return 'bnb-chart'; }

      static get properties() {
        return {
          chart: {
            notify: true
          },
          data: {
            type: Object,
            value: function () {
              return null;
            }
          },
          model: {
            type: Array,
            value: function () {
              return [];
            }
          },
          symbol: {
            type: String,
            value: ''
          },
          type: {
            type: String,
            value: 'line'
          },
          selectedPage: {
            type: Number,
            value: 0
          }
        }
      }

      static get observers() {
        return [
          'updateChart(data.*)'
        ];
      }

      ready() {
        super.ready();
        this.addEventListener('iron-resize', this.onIronResize);
      }

      onIronResize() {
        if (this.chart) {
          this.chart.resize();
          this.chart.render(true);
        }
      }

      updateChart() {
        if (this.data) {
          if (this.hasValues(this.data)) {
            this.selectedPage = 2;
          }
          else {
            this.selectedPage = 1;
          }
        }
        else {
          this.selectedPage = 0;
        }

        if (this.data && this.hasValues(this.data)) {
          let chartData = this.createChartData();

          if (this.chart) {
            if (!_.isEqual(this.oldData, this.data)) {
              this.chart.data.datasets = chartData.datasets;
              this.chart.update();

              this.oldData = this.data;
            }
          }
          else {
            let chartType = 'line';
            switch (this.type) {
              case 'area':
              case 'line':
                chartType = 'line';
                break;
              case 'bar':
                chartType = 'bar';
                break;
            }

            let options = {
              maintainAspectRatio: false,
              legend: {
                position: 'bottom',
                labels: {
                  fontColor: '#fff'
                }
              },
              tooltips: {
                position: 'nearest',
                mode: 'index',
                intersect: false,
                callbacks: {}
              },
              scales: {
                xAxes: [{
                  type: 'time',
                  ticks: {
                    fontColor: '#fff'
                  }
                }],
                yAxes: [{
                  stacked: this.type === 'area',
                  ticks: {
                    fontColor: '#fff',
                    beginAtZero: true
                  }
                }]
              }
            };

            if (this.type === 'area') {
              options.tooltips.callbacks.footer = function(tooltipItems, data) {
                  let sum = 0;
                  tooltipItems.forEach(function(tooltipItem) {
                      sum += data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index].y;
                  });
                  return 'Total: ' + Math.round(sum);
                };
            }

            let ctx = this.$.chart;
            this.chart = new Chart(ctx, {
              type: chartType,
              data: chartData,
              options: options
            });
          }
        }
      }

      transparentize(color, opacity) {
			  let alpha = opacity === undefined ? 0.5 : 1 - opacity;
			  return Color(color).alpha(alpha).rgbString();
      }

      hasValues(data) {
        let resu = false;
        for (let i = 0; i < data.length && !resu; i++) {
          resu = data[i].values.length > 0;
        }
        return resu;
      }

      createChartData() {
        let resu = {
          datasets: []
        };
        for (let i = 0; i < this.model.length; i++) {
          let dataset = {};
          dataset.label = this.model[i].label;
          dataset.fill = i === 0 ? 'origin' : '-1';
          dataset.backgroundColor = this.transparentize(this.model[i].color);
          dataset.borderColor = this.model[i].color;
          dataset.data = this.createValues(this.model[i].name);
          resu.datasets.push(dataset);
        }
        return resu;
      }

      createValues(key) {
        let item = _.find(this.data, function(i) { return i.key === key; });
    		let resu = [];
        if (item) {
      		for (let i = 0; i < item.values.length; i++) {
      			let time = new Date(item.values[i].time);
      			resu.push( {x: time, y: item.values[i].value});
      		}
        }
    		return resu;
    	}
    }
    window.customElements.define(BnbChart.is, BnbChart);
  </script>

</dom-module>
