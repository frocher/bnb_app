<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bnb-common-styles.html">
<link rel="import" href="bnb-divider.html">
<link rel="import" href="bnb-period-dropdown.html">
<link rel="import" href="bnb-chart-card.html">

<dom-module id="bnb-page">
  <template>
    <style include="bnb-common-styles">
      :host {
        @apply --layout-vertical;
      }

      #chartsFilter {
        margin:16px;
        padding:16px;
      }

      #charts {
        @apply --layout-vertical;
        @apply --layout-wrap;
        @apply --layout-center-justified;
      }

      paper-item {
        cursor: pointer;
      }
    </style>

    <app-header-layout fullbleed>
      <app-header slot="header" fixed condenses shadow>
        <app-toolbar>
          <paper-icon-button icon="arrow-back" on-tap="backTapped"></paper-icon-button>
          <span>[[page.name]]</span>
          <div class="flex"></div>
          <paper-menu-button horizontal-align="right">
            <paper-icon-button icon="more-vert" slot="dropdown-trigger"></paper-icon-button>
            <paper-listbox slot="dropdown-content">
              <paper-item on-tap="editTapped" hidden$="{{!page.can_edit}}">Settings</paper-item>
              <paper-item on-tap="membersTapped">Members</paper-item>
              <bnb-divider></bnb-divider>
              <paper-item on-tap="deleteTapped" hidden$="{{!page.can_delete}}">Delete</paper-item>
              <paper-item on-tap="leaveTapped" hidden$="{{page.can_delete}}">Leave</paper-item>
            </paper-listbox>
          </paper-menu-button>
        </app-toolbar>
      </app-header>

      <div id="content" class="fit">

        <div id="charts">
          <paper-card id="chartsFilter">
            <span>Stats for&nbsp;</span>
            <bnb-period-dropdown period="{{period}}"></bnb-period-dropdown>
          </paper-card>

          <bnb-chart-card id="performanceChart" name="Load times" data="[[page.stats.performance]]" model="[[performanceModel]]"></bnb-chart-card>
          <bnb-chart-card id="uptimeChart" name="Uptime" data="[[page.stats.uptime]]" model="[[uptimeModel]]"></bnb-chart-card>
          <bnb-chart-card id="requestsChart" name="Assets count" stacked="true" data="[[page.stats.requests]]" model="[[requestsModel]]"></bnb-chart-card>
          <bnb-chart-card id="bytesChart" name="Assets size" stacked="true" data="[[page.stats.bytes]]" model="[[bytesModel]]"></bnb-chart-card>
        </div>

      </div>
    </app-header-layout>

    <paper-dialog id="deleteDlg" modal>
      <p>Are you really sure you want to delete page ? All data will be lost</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="deletePage">Delete</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="leaveDlg" modal>
      <p>Leave this page, sure ?</p>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="leavePage">Leave</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class BnbPage extends Polymer.Element {
      static get is() { return 'bnb-page'; }

      static get properties() {
        return {
          page: Object,
          period: Object,
          performanceModel: Object,
          uptimeModel: Object,
          requestsModel: Object,
          bytesModel: Object
        }
      }

      ready() {
        super.ready();
        this.performanceModel = [
          {name: 'response_start', color: '#E65100', label: 'response time', suffix: 'ms'},
          {name: 'first_paint', color: '#F57C00', label: 'first paint', suffix: 'ms'},
          {name: 'speed_index', color: '#FF9800', label: 'speed index'},
          {name: 'dom_ready', color: '#FFB74D', label: 'dom ready', suffix: 'ms'},
          {name: 'page_load', color: '#FFE0B2', label: 'fully loaded', suffix: 'ms'}
        ];

        this.uptimeModel = [
          {name: 'uptime', color: '#00C853', label: 'uptime', suffix: '%'}
        ];

        this.requestsModel = [
          {name: 'html', color: '#01579B', label: 'html'},
          {name: 'css', color: '#0288D1', label: 'css'},
          {name: 'js', color: '#03A9F4', label: 'javascript'},
          {name: 'image', color: '#4FC3F7', label: 'image'},
          {name: 'font', color: '#81D4FA', label: 'font'},
          {name: 'other', color: '#B3E5FC', label: 'other'}
        ];

        this.bytesModel = [
          {name: 'html', color: '#880E4F', label: 'html', suffix: 'kb'},
          {name: 'css', color: '#C2185B', label: 'css', suffix: 'kb'},
          {name: 'js', color: '#D81B60', label: 'javascript', suffix: 'kb'},
          {name: 'image', color: '#EC407A', label: 'image', suffix: 'kb'},
          {name: 'font', color: '#F48FB1', label: 'font', suffix: 'kb'},
          {name: 'other', color: '#F8BBD0', label: 'other', suffix: 'kb'}
        ];
      }

      backTapped() {
        window.history.pushState({}, null, '/home');
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      editTapped() {
        window.history.pushState({}, null, '/edit-page/' + this.page.id);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      membersTapped() {
        window.history.pushState({}, null, '/edit-members/' + this.page.id);
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      deleteTapped() {
        this.$.deleteDlg.open();
      }

      deletePage() {
        BnbService.deletePage(this.page.id);
      }

      handleDeleteResponse(data) {
        this.fire('page-deleted', {page: page});
        this.fire('message', {message: "Page has been deleted"});
      }

      handleDeleteError(error) {
        this.fire('message', {message: "Error : can't delete page"});
      }

      leaveTapped(e) {
        this.$.leaveDlg.open();
      }

      leavePage(e) {
        BnbService.removeMember(this.page.id, -1);
      }

      handleLeaveResponse(data) {
        this.fire('page-left', {page: page});
        this.fire('message', {message: "You have left the page"});
      }

      handleLeaveError(error) {
        this.fire('message', {message: "Error : can't leave page"});
      }

    }
    window.customElements.define(BnbPage.is, BnbPage);

  </script>

</dom-module>
