<link rel="import" href="bnb-redux.html">
<script>
  BnbActions = Parent => class BnbActions extends BnbRedux(Parent) {

    static get actions() {
      return {
        updateRoute(route) {
          return {
            type: 'UPDATE_ROUTE',
            route: route,
            errors: []
          }
        },

        updateMessage(message) {
          return {
            type: 'UPDATE_MESSAGE',
            message: message
          }
        },

        updatePeriod(period) {
          return {
            type: 'UPDATE_PERIOD',
            period: period
          }
        },

        fetchEnvironmentSuccess(keys) {
          return {
            type: 'ENVIRONMENT_FETCH_SUCCESS',
            analyticsKey: keys.GOOGLE_ANALYTICS_KEY,
            pushKey: keys.PUSH_KEY,
          }
        },

        fetchEnvironmentError(message) {
          return {
            type: 'ENVIRONMENT_FETCH_ERROR',
            message: message
          }
        },

        signInSuccess(credentials) {
          return {
            type: 'SIGN_IN_SUCCESS',
            credentials: credentials
          }
        },

        signInError(errors) {
          return {
            type: 'SIGN_IN_ERROR',
            errors: errors
          }
        },

        signUpSuccess() {
          return {
            type: 'SIGN_UP_SUCCESS'
          }
        },

        signUpError(errors) {
          return {
            type: 'SIGN_UP_ERROR',
            errors: errors
          }
        },

        forgotPasswordSuccess(message) {
          return {
            type: 'FORGOT_PASSWORD_SUCCESS',
            message: message
          }
        },

        forgotPasswordError(errors) {
          return {
            type: 'FORGOT_PASSWORD_ERROR',
            message: errors[0]
          }
        },

        updatePasswordSuccess(message) {
          return {
            type: 'UPDATE_PASSWORD_SUCCESS',
            message: message
          }
        },

        updatePasswordError(errors) {
          return {
            type: 'UPDATE_PASSWORD_ERROR',
            errors: errors
          }
        },

        signOut() {
          return {
            type: 'SIGN_OUT'
          }
        },

        fetchUserSuccess(user) {
          return {
            type: 'USER_FETCH_SUCCESS',
            user: user
          }
        },

        fetchUserError(message) {
          return {
            type: 'USER_FETCH_ERROR',
            message: message
          }
        },

        updateUserStart() {
          return {
            type: 'USER_FETCH_START'
          }
        },

        updateUserSuccess(user) {
          return {
            type: 'USER_UPDATE_SUCCESS',
            user: user
          }
        },

        updateUserError(errors) {
          return {
            type: 'USER_UPDATE_ERROR',
            errors: errors
          }
        },

        saveSubscriptionSuccess() {
          return {
            type: 'SUBSCRIPTION_SUCCESS'
          }
        },

        saveSubscriptionError(errors) {
          return {
            type: 'SUBSCRIPTION_ERROR',
            errors: errors
          }
        },

        fetchPagesSuccess(pages) {
          return {
            type: 'PAGES_FETCH_SUCCESS',
            pages: pages
          }
        },

        fetchPagesError(errors) {
          return {
            type: 'PAGES_FETCH_ERROR',
            errors: errors
          }
        },

        fetchPageSuccess(page) {
          return {
            type: 'PAGE_FETCH_SUCCESS',
            page: page
          }
        },

        fetchPageError(errors) {
          return {
            type: 'PAGE_FETCH_ERROR',
            errors: errors
          }
        },

        fetchPageMembersSuccess(members) {
          return {
            type: 'PAGE_MEMBERS_FETCH_SUCCESS',
            members: members
          }
        },

        fetchPageMembersError(errors) {
          return {
            type: 'PAGE_MEMBERS_FETCH_ERROR',
            errors: errors
          }
        },

        fetchPageStatsStart() {
          return {
            type: 'PAGE_STATS_START'
          }
        },

        fetchPageStatsSuccess(stats) {
          return {
            type: 'PAGE_STATS_FETCH_SUCCESS',
            stats: stats
          }
        },

        fetchPageStatsError(errors) {
          return {
            type: 'PAGE_STATS_FETCH_ERROR',
            errors: errors
          }
        },

        fetchLighthouseDetailsStart() {
          return {
            type: 'LIGHTHOUSE_DETAILS_START'
          }
        },

        fetchLighthouseDetailsSuccess(details) {
          return {
            type: 'LIGHTHOUSE_DETAILS_FETCH_SUCCESS',
            details: details
          }
        },

        fetchLighthouseDetailsError(errors) {
          return {
            type: 'LIGHTHOUSE_DETAILS_FETCH_ERROR',
            errors: errors
          }
        },

        fetchUptimeDetailsStart() {
          return {
            type: 'UPTIME_DETAILS_START'
          }
        },

        fetchUptimeDetailsSuccess(details) {
          return {
            type: 'UPTIME_DETAILS_FETCH_SUCCESS',
            details: details
          }
        },

        fetchUptimeDetailsError(errors) {
          return {
            type: 'UPTIME_DETAILS_FETCH_ERROR',
            errors: errors
          }
        },

        fetchAssetsDetailsStart() {
          return {
            type: 'ASSETS_DETAILS_START'
          }
        },

        fetchAssetsDetailsSuccess(details) {
          return {
            type: 'ASSETS_DETAILS_FETCH_SUCCESS',
            details: details
          }
        },

        fetchAssetsDetailsError(errors) {
          return {
            type: 'ASSETS_DETAILS_FETCH_ERROR',
            errors: errors
          }
        },

        createPageSuccess() {
          return {
            type: 'PAGE_CREATE_SUCCESS'
          }
        },

        createPageError(errors) {
          return {
            type: 'PAGE_CREATE_ERROR',
            errors: errors
          }
        },

        updatePageSuccess(page) {
          return {
            type: 'PAGE_UPDATE_SUCCESS',
            page: page
          }
        },

        updatePageError(errors) {
          return {
            type: 'PAGE_UPDATE_ERROR',
            errors: errors
          }
        },

        deletePageSuccess(page) {
          return {
            type: 'PAGE_DELETE_SUCCESS',
            page: page
          }
        },

        deletePageError(errors) {
          return {
            type: 'PAGE_DELETE_ERROR',
            errors: errors
          }
        },

        fetchBudgetsSuccess(budgets) {
          return {
            type: 'BUDGETS_FETCH_SUCCESS',
            budgets: budgets
          }
        },

        fetchBudgetsError(errors) {
          return {
            type: 'BUDGETS_FETCH_ERROR',
            errors: errors
          }
        },

        createBudgetSuccess() {
          return {
            type: 'BUDGET_CREATE_SUCCESS'
          }
        },

        createBudgetError(errors) {
          return {
            type: 'BUDGET_CREATE_ERROR',
            errors: errors
          }
        },

        deleteBudgetSuccess(budget) {
          return {
            type: 'BUDGET_DELETE_SUCCESS',
            budget: budget
          }
        },

        deleteBudgetError(errors) {
          return {
            type: 'BUDGET_DELETE_ERROR',
            errors: errors
          }
        },

        createPageMemberSuccess(member) {
          return {
            type: 'PAGE_MEMBER_CREATE_SUCCESS',
            member: member
          }
        },

        createPageMemberError(message) {
          return {
            type: 'PAGE_MEMBER_CREATE_ERROR',
            message: message
          }
        },

        updatePageMemberSuccess(member) {
          return {
            type: 'PAGE_MEMBER_UPDATE_SUCCESS',
            member: member
          }
        },

        updatePageMemberError(message) {
          return {
            type: 'PAGE_MEMBER_UPDATE_ERROR',
            message: message
          }
        },

        deletePageMemberSuccess(member) {
          return {
            type: 'PAGE_MEMBER_DELETE_SUCCESS',
            member: member
          }
        },

        deletePageMemberError(message) {
          return {
            type: 'PAGE_MEMBER_DELETE_ERROR',
            message: message
          }
        }
      }
    }

    /**
     * Compute API base url.
     */
    static get baseUrl() {
      return '/api/';
    }

    /**
     * Build an absolute URL from a partial url and query parameters
     */
    getRequestUrl(url, params) {
      let queryString = this._getQueryString(params);
      if (queryString) {
        return BnbActions.baseUrl + url + '?' + queryString;
      }
      return BnbActions.baseUrl + url;
    }

    /**
     * Is user currently logged
     * @return {Boolean} true if logged, false otherwise
     */
    isLogged() {
      return _fetchCredentials();
    }

    loadEnvironment() {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/environment', {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchEnvironmentSuccess', response);
            }
            else {
              dispatch('fetchEnvironmentKeyError', response.errors);
            }
          }
        });
      });
    }

    signin(email, password) {
      this.dispatch((dispatch) => {
        let url = this.getRequestUrl('/auth/sign_in', {email: email, password: password});
        this._getResource({
          url: url,
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('signInSuccess', this._extractCredentials(e.target));
            }
            else {
              dispatch('signInError', response.errors);
            }
          }
        });
      });
    }

    signout() {
      this.dispatch('signOut');
    }

    signup(name, email, password, confirmation, successUrl) {
      this.dispatch((dispatch) => {
        let url = this.getRequestUrl('/auth/', {
          name: name,
          email: email,
          password: password,
          password_confirmation: confirmation,
          confirm_success_url: successUrl
        });

        this._getResource({
          url: url,
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('signUpSuccess');
            }
            else {
              dispatch('signUpError', response.errors);
            }
          }
        });
      });
    }

    forgotPassword(email, redirectUrl) {
      this.dispatch((dispatch) => {
        let url = this.getRequestUrl('/auth/password', {
          email: email,
          redirect_url: redirectUrl
        });

        this._getResource({
          url: url,
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('forgotPasswordSuccess', response.message);
            }
            else {
              dispatch('forgotPasswordError', response.errors);
            }
          }
        });
      });
    }

    updatePassword(password, passwordConfirmation, headers) {
      this.dispatch((dispatch) => {
        let url = this.getRequestUrl('/auth/password', {
          password: password,
          password_confirmation: passwordConfirmation
        });

        this._getResource({
          url: url,
          method: 'PUT',
          headers: headers,
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('updatePasswordSuccess', response.message);
            }
            else {
              dispatch('updatePasswordError', response.errors);
            }
          }
        });
      });
    }

    loadPages() {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages', {per_page:9999}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchPagesSuccess', response);
            }
            else {
              dispatch('fetchPagesError', response.errors);
            }
          }
        });
      });
    }

    loadPage(id) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + id, {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchPageSuccess', response);
            }
            else {
              dispatch('fetchPageError', response.errors);
            }
          }
        });
      });
    }

    loadPageMembers(pageId) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/members', {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchPageMembersSuccess', response);
            }
            else {
              dispatch('fetchPageMembersError', response.errors);
            }
          }
        });
      });
    }

    loadPageStats(pageId) {
      this.dispatch((dispatch) => {
        dispatch('fetchPageStatsStart');

        let start = this.period.start;
        let end   = this.period.end;
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/stats', {start: start, end: end}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this._updateUptime(response.uptime[0]);
              this._updateCount(response.performance);
              this._updateBytes(response.bytes);
              this._updateCount(response.requests);

              dispatch('fetchPageStatsSuccess', response);
            }
            else {
              dispatch('fetchPageStatsError', response.errors);
            }
          }
        });
      });
    }

    loadLighthouseDetails(pageId) {
      this.dispatch((dispatch) => {
        dispatch('fetchLighthouseDetailsStart');

        let start = this.period.start;
        let end   = this.period.end;
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/lighthouse', {start: start, end: end}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchLighthouseDetailsSuccess', response);
            }
            else {
              dispatch('fetchLighthouseDetailsError', response.errors);
            }
          }
        });
      });
    }

    loadUptimeDetails(pageId) {
      this.dispatch((dispatch) => {
        dispatch('fetchUptimeDetailsStart');

        let start = this.period.start;
        let end   = this.period.end;
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/uptime', {start: start, end: end}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchUptimeDetailsSuccess', response);
            }
            else {
              dispatch('fetchUptimeDetailsError', response.errors);
            }
          }
        });
      });
    }

    loadAssetsDetails(pageId) {
      this.dispatch((dispatch) => {
        dispatch('fetchAssetsDetailsStart');

        let start = this.period.start;
        let end   = this.period.end;
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/assets', {start: start, end: end}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchAssetsDetailsSuccess', response);
            }
            else {
              dispatch('fetchAssetsDetailsError', response.errors);
            }
          }
        });
      });
    }

    createPage(name, url) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages', { name: name, url: url }),
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('createPageSuccess');
            }
            else {
              dispatch('createPageError', response.errors);
            }
          }
        });
      });
    }

    updatePage(id, page) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + id, page),
          method: 'PUT',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('updatePageSuccess', response);
            }
            else {
              dispatch('updatePageError', response.errors);
            }
          }
        });
      });
    }

    deletePage(id) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + id, {}),
          method: 'DELETE',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('deletePageSuccess', response);
            }
            else {
              dispatch('deletePageError', response.errors);
            }
          }
        });
      });
    }

    loadBudgets(pageId) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/budgets', {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchBudgetsSuccess', response);
            }
            else {
              dispatch('fetchBudgetsError', response.errors);
            }
          }
        });
      });
    }

    createBudget(pageId, category, item, budget) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/budgets', { category: category, item: item, budget: budget }),
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadBudgets(pageId);
              dispatch('createBudgetSuccess');
            }
            else {
              dispatch('createBudgetError', response.errors);
            }
          }
        });
      });
    }

    deleteBudget(pageId, budgetId) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/budgets/' + budgetId, {}),
          method: 'DELETE',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadBudgets(pageId);
              dispatch('deleteBudgetSuccess', response);
            }
            else {
              dispatch('deleteBudgetError', response.errors);
            }
          }
        });
      });
    }

    createPageMember(pageId, member) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/members', member),
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadPageMembers(pageId);
              dispatch('createPageMemberSuccess', response);
            }
            else {
              dispatch('createPageMemberError', response.message);
            }
          }
        });
      });
    }

    updatePageMember(pageId, member) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/members/'  + member.id, member),
          method: 'PUT',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadPageMembers(pageId);
              dispatch('updatePageMemberSuccess', response);
            }
            else {
              dispatch('updatePageMemberError', response.message);
            }
          }
        });
      });
    }

    deletePageMember(pageId, memberId) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/pages/' + pageId + '/members/' + memberId, {}),
          method: 'DELETE',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              this.loadPageMembers(pageId);
              dispatch('deletePageMemberSuccess', response);
            }
            else {
              dispatch('deletePageMemberError', response.message);
            }
          }
        });
      });
    }

    loadUser() {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/users/-1', {}),
          method: 'GET',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('fetchUserSuccess', response);
            }
            else {
              dispatch('fetchUserError', response.errors);
            }
          }
        });
      });
    }

    updateUser(id, user) {
      this.dispatch((dispatch) => {
        dispatch('updateUserStart');
        this._getResource({
          url: this.getRequestUrl('/users/' + id, user),
          method: 'PUT',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('updateUserSuccess', response);
            }
            else {
              dispatch('updateUserError', response.errors);
            }
          }
        });
      });
    }

    saveSubscription(subscription) {
      this.dispatch((dispatch) => {
        this._getResource({
          url: this.getRequestUrl('/users/-1/save-subscription', { subscription: JSON.stringify(subscription) }),
          method: 'POST',
          onLoad(e) {
            let response = JSON.parse(e.target.responseText);
            if (e.target.status === 200) {
              dispatch('saveSubscriptionSuccess');
            }
            else {
              dispatch('saveSubscriptionError', response.errors);
            }
          }
        });
      });
    }

    _updateUptime(data) {
      data.summary = Math.round(data.summary * 10000) / 100;
      for (let i = 0; i < data.values.length; i++) {
        data.values[i].value = Math.round(data.values[i].value * 10000) / 100;
      }
    }

    _updateCount(data) {
      for (let iSeries = 0; iSeries < data.length; iSeries++) {
        let serie = data[iSeries];
        serie.summary = Math.round(serie.summary);
        for (let iValue = 0; iValue < serie.values.length; iValue++) {
          serie.values[iValue].value = Math.round(serie.values[iValue].value);
        }
      }
    }

    _updateBytes(data) {
      for (let iSeries = 0; iSeries < data.length; iSeries++) {
        let serie = data[iSeries];
        serie.summary = Math.round(serie.summary*10/1024)/10;
        for (let iValue = 0; iValue < serie.values.length; iValue++) {
          serie.values[iValue].value = Math.round(serie.values[iValue].value*10/1024)/10;
        }
      }
    }

    /**
     * Extract credentials from a HTTP response
     */
    _extractCredentials(xhr) {
      return {
        'access-token': xhr.getResponseHeader('access-token'),
        uid: xhr.getResponseHeader('uid'),
        client: xhr.getResponseHeader('client'),
        'token-type': 'Bearer'
      };
    }

    /**
     * Perform a XMLHttpRequest
     * @param {Object} parameters
     */
    _getResource(rq) {
      let xhr = new XMLHttpRequest();

      xhr.addEventListener('load', (e) => {
        rq.onLoad.call(this, e);
      });

      xhr.addEventListener('error', (e) => {
        if (rq.onError) {
          rq.onError.call(this, e);
        }
        else {
          this.dispatch('updateMessage', 'Network failure. Try again.');
        }
      });

      xhr.open(rq.method, rq.url);

      let headers = this._fetchCredentials() || {};
      if (rq.headers) {
        headers = Object.assign(headers, rq.headers)
      }
      for (let header in headers) {
        if (headers[header]) {
          xhr.setRequestHeader(header, headers[header].toString());
        }
      }

      xhr.send();
    }

    /**
     * Store credentials in session storage.
     */
    storeCredentials(accessToken, uid, client) {
      let credentials = {
        'access-token': accessToken,
        uid: uid,
        client: client,
        'token-type': 'Bearer'
      };

      sessionStorage.setItem('credentials', JSON.stringify(credentials));
    }

    /**
     * Extract credentials from session storage.
     * @return {Object} credentials or undefined if user is not logged in
     */
    _fetchCredentials() {
      let credentials = sessionStorage.getItem('credentials');
      if (credentials) {
        return JSON.parse(credentials);
      }
      return undefined;
    }


    /**
     * Build a query string from a params object.
     */
    _getQueryString(params) {
      let queryParts = [];

      for (let param in params) {
        let value = params[param];
        param = window.encodeURIComponent(param);

        if (value !== null) {
          param += '=' + window.encodeURIComponent(value);
        }

        queryParts.push(param);
      }

      return queryParts.join('&');
    }

    /**
     * Validate or invalidate fields from an errors Array
     * @param {Array} newVal
     */
    _errorsChanged(newVal) {
      if (this.errors) {
        for (let prop in this.errors) {
          if (this.errors.hasOwnProperty(prop)) {
            let objId = prop;
            if (this.$[objId] !== undefined) {
              this.$[objId].invalid = true;
              this.$[objId].errorMessage = this.errors[prop][0];
            }
          }
        }
      }
    }
  }
</script>
