<link rel="import" href="../bower_components/polymer-redux/polymer-redux.html">
<script src="../node_modules/redux/dist/redux.min.js"></script>
<script src="../node_modules/redux-thunk/dist/redux-thunk.min.js"></script>
<script src="../bower_components/moment/min/moment.min.js"></script>

<script>

  function _fetchCredentials() {
    let credentials = sessionStorage.getItem('credentials');
    if (credentials) {
      return JSON.parse(credentials);
    }
    return undefined;
  }

  // Initial state
  const initial = {
    // Google Analytics key
    analyticsKey: null,

    // Push notification key
    pushKey: null,

    // Text for message toast
    message: {
      text: '',
      counter: 0
    },

    // User credentials for API
    credentials: _fetchCredentials(),

    // Form validation errors
    errors: [],

    // Selected period
    period: {start: moment().subtract(30, 'days').toDate(), end: moment().toDate()},

    // Loaded pages
    pages: undefined,

    // Current page
    page: undefined,

    // Members of current page
    page_members: undefined,

    // Statistics of current page
    page_stats: undefined,

    // Lighthouse details of current page
    lighthouse_details: undefined,

    // Uptime details of current page
    uptime_details: undefined,

    // Assets details of current page
    assets_details: undefined
  };

  const reducer = (state, action) => {
    state = state || initial;

    switch (action.type) {
      case 'UPDATE_ROUTE':
        return Object.assign({}, state, {
          route: action.route
        });

      case 'ENVIRONMENT_FETCH_SUCCESS':
        return Object.assign({}, state, {
          analyticsKey: action.analyticsKey,
          pushKey: action.pushKey
        });

      case 'UPDATE_MESSAGE':
        return Object.assign({}, state, {
          message: {text: action.message, counter: state.message.counter + 1}
        });

      case 'UPDATE_PERIOD':
        return Object.assign({}, state, {
          period: action.period
        });

      case 'SIGN_IN_SUCCESS':
        sessionStorage.setItem('credentials', JSON.stringify(action.credentials));
        return Object.assign({}, state, {
          credentials: action.credentials,
          route: 'home'
        });

      case 'ENVIRONMENT_FETCH_ERROR':
      case 'SIGN_IN_ERROR':
      case 'USER_FETCH_ERROR':
      case 'PAGES_FETCH_ERROR':
      case 'PAGE_FETCH_ERROR':
      case 'PAGE_MEMBERS_FETCH_ERROR':
      case 'PAGE_STATS_FETCH_ERROR':
        let message = action.errors !== undefined ? action.errors[0] : 'Oops something went wrong.';
        return Object.assign({}, state, {
          message: {text: message, counter: state.message.counter + 1},
        });

      case 'SIGN_UP_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'Sign up successful. An activation email has been sent to you.', counter: state.message.counter + 1},
        });

      case 'SIGN_UP_ERROR':
        if (action.errors) {
          return Object.assign({}, state, {
            errors: action.errors
          });
        }
        else {
          return Object.assign({}, state, {
            message: {text: 'Unknown error. Can\'t signup.', counter: state.message.counter + 1},
          });
        }

      case 'FORGOT_PASSWORD_SUCCESS':
      case 'FORGOT_PASSWORD_ERROR':
        return Object.assign({}, state, {
          message: {text: action.message, counter: state.message.counter + 1},
        });

      case 'UPDATE_PASSWORD_SUCCESS':
        return Object.assign({}, state, {
          message: {text: action.message, counter: state.message.counter + 1},
          route: 'signin'
        });

      case 'UPDATE_PASSWORD_ERROR':
        return Object.assign({}, state, {
          errors: action.errors
        });

      case 'SIGN_OUT':
        sessionStorage.removeItem('credentials');
        return Object.assign({}, state, {
          credentials: null,
          route: 'signin'
        });

      case 'USER_FETCH_SUCCESS':
        return Object.assign({}, state, {
          user: action.user
        });

      case 'USER_UPDATE_START':
        return Object.assign({}, state, {
          errors: []
        });

      case 'USER_UPDATE_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'User preferences have been updated', counter: state.message.counter + 1},
          route: 'home'
        });

      case 'USER_UPDATE_ERROR':
        return Object.assign({}, state, {
          errors: action.errors
        });

      case 'PAGES_FETCH_SUCCESS':
        return Object.assign({}, state, {
          pages: action.pages
        });

      case 'PAGE_FETCH_SUCCESS':
        return Object.assign({}, state, {
          page: action.page
        });

      case 'PAGE_MEMBERS_FETCH_SUCCESS':
        return Object.assign({}, state, {
          page_members: action.members
        });

      case 'PAGE_STATS_START':
        return Object.assign({}, state, {
          page_stats: null
        });

      case 'PAGE_STATS_FETCH_SUCCESS':
        return Object.assign({}, state, {
          page_stats: action.stats
        });

      case 'LIGHTHOUSE_DETAILS_START':
        return Object.assign({}, state, {
          lighthouse_details: null
        });

      case 'LIGHTHOUSE_DETAILS_FETCH_SUCCESS':
        return Object.assign({}, state, {
          lighthouse_details: action.details
        });

      case 'UPTIME_DETAILS_START':
        return Object.assign({}, state, {
          uptime_details: null
        });

      case 'UPTIME_DETAILS_FETCH_SUCCESS':
        return Object.assign({}, state, {
          uptime_details: action.details
        });

      case 'ASSETS_DETAILS_START':
        return Object.assign({}, state, {
          assets_details: null
        });

      case 'ASSETS_DETAILS_FETCH_SUCCESS':
        return Object.assign({}, state, {
          assets_details: action.details
        });

      case 'PAGE_CREATE_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'Page has been created', counter: state.message.counter + 1},
          route: 'home'
        });

      case 'PAGE_UPDATE_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'Page has been updated', counter: state.message.counter + 1},
          page: action.page,
          route: 'page/' + action.page.id
        });

      case 'PAGE_DELETE_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'Page has been deleted', counter: state.message.counter + 1},
          page: action.page,
          route: 'home'
        });

      case 'PAGE_MEMBER_CREATE_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'Member has been added', counter: state.message.counter + 1}
        });

      case 'PAGE_MEMBER_UPDATE_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'Member has been updated', counter: state.message.counter + 1}
        });

      case 'PAGE_MEMBER_DELETE_SUCCESS':
        return Object.assign({}, state, {
          message: {text: 'Member has been removed', counter: state.message.counter + 1}
        });

      case 'PAGE_MEMBER_CREATE_ERROR':
      case 'PAGE_MEMBER_UPDATE_ERROR':
      case 'PAGE_MEMBER_DELETE_ERROR':
      case 'SUBSCRIPTION_ERROR':
        return Object.assign({}, state, {
          message: {text: action.message, counter: state.message.counter + 1}
        });

      case 'PAGE_CREATE_ERROR':
      case 'PAGE_UPDATE_ERROR':
      case 'PAGE_DELETE_ERROR':
        if (action.errors) {
          return Object.assign({}, state, {
            errors: action.errors
          });
        }
        else {
          return Object.assign({}, state, {
            message: {text: 'Unknown error.', counter: state.message.counter + 1},
          });
        }


      default:
        return state;
    }
  };

  const store = Redux.createStore(
    reducer,
    Redux.applyMiddleware(ReduxThunk.default)
  );

  // Export the ReduxMixin
  BnbRedux = PolymerRedux(store);
</script>
